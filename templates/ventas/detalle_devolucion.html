{% extends 'base.html' %}
{% load static %}

{% block title %}{{ titulo }}{% endblock %}

{% block extra_css %}
<style>
.devolucion-header {
    background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    color: white;
    border-radius: 10px;
    padding: 30px;
    margin-bottom: 30px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.info-card {
    border-radius: 10px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    margin-bottom: 20px;
    transition: transform 0.3s ease;
}

.info-card:hover {
    transform: translateY(-2px);
}

.info-card .card-header {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-bottom: 1px solid #dee2e6;
    font-weight: bold;
}

.producto-devuelto {
    border-left: 4px solid #dc3545;
    background: #fff5f5;
    padding: 15px;
    margin-bottom: 10px;
    border-radius: 0 8px 8px 0;
}

.motivo-badge {
    font-size: 1.1em;
    padding: 0.5rem 1rem;
}

.motivo-defectuoso { background-color: #dc3545; }
.motivo-cambio { background-color: #ffc107; color: #000; }
.motivo-error { background-color: #fd7e14; }
.motivo-cliente { background-color: #17a2b8; }

.total-devolucion {
    background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    color: white;
    border-radius: 10px;
    padding: 20px;
    text-align: center;
}

.btn-imprimir {
    background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
    border: none;
    color: white;
}

.btn-imprimir:hover {
    background: linear-gradient(135deg, #495057 0%, #6c757d 100%);
    color: white;
}

.timeline-item {
    border-left: 3px solid #dc3545;
    padding-left: 20px;
    margin-bottom: 20px;
    position: relative;
}

.timeline-item::before {
    content: '';
    width: 12px;
    height: 12px;
    background: #dc3545;
    border-radius: 50%;
    position: absolute;
    left: -7px;
    top: 5px;
}

.datos-tecnicos {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    font-family: 'Courier New', monospace;
    font-size: 0.9em;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header de Devolución -->
    <div class="devolucion-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h2><i class="fas fa-undo-alt"></i> {{ titulo }}</h2>
                <p class="mb-0">{{ subtitulo }}</p>
                <div class="mt-3">
                    <span class="badge motivo-{{ devolucion.motivo }} motivo-badge">
                        {{ devolucion.get_motivo_display }}
                    </span>
                </div>
            </div>
            <div class="col-md-4 text-center">
                <div class="total-devolucion">
                    <h5>Total Devuelto</h5>
                    <h2>$ {{ devolucion.total_devolucion|floatformat:2 }}</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Botones de Acción -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <a href="{% url 'ventas:devoluciones' %}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Volver a Lista
            </a>
        </div>
        <div>
            <button class="btn btn-imprimir" onclick="imprimirDevolucion()">
                <i class="fas fa-print"></i> Imprimir Devolución
            </button>
            <a href="{% url 'ventas:detalle_factura_electronica' devolucion.factura_original.idFactura %}" 
               class="btn btn-outline-primary">
                <i class="fas fa-receipt"></i> Ver Factura Original
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Información General -->
        <div class="col-md-6">
            <div class="info-card card">
                <div class="card-header">
                    <i class="fas fa-info-circle"></i> Información General
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <tr>
                            <td><strong>Número de Devolución:</strong></td>
                            <td class="text-danger">{{ devolucion.numero_devolucion }}</td>
                        </tr>
                        <tr>
                            <td><strong>Fecha de Devolución:</strong></td>
                            <td>{{ devolucion.fecha|date:"d/m/Y H:i" }}</td>
                        </tr>
                        <tr>
                            <td><strong>Usuario que Procesó:</strong></td>
                            <td>
                                <span class="text-info">
                                    {{ devolucion.usuario.get_full_name|default:devolucion.usuario.username }}
                                </span>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Motivo:</strong></td>
                            <td>
                                <span class="badge motivo-{{ devolucion.motivo }} motivo-badge">
                                    {{ devolucion.get_motivo_display }}
                                </span>
                            </td>
                        </tr>
                        {% if devolucion.observaciones %}
                        <tr>
                            <td><strong>Observaciones:</strong></td>
                            <td>{{ devolucion.observaciones }}</td>
                        </tr>
                        {% endif %}
                    </table>
                </div>
            </div>
        </div>

        <!-- Información de la Venta Original -->
        <div class="col-md-6">
            <div class="info-card card">
                <div class="card-header">
                    <i class="fas fa-receipt"></i> Venta Original
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <tr>
                            <td><strong>Número de Factura:</strong></td>
                            <td class="text-primary">{{ devolucion.factura_original.numeroFactura }}</td>
                        </tr>
                        <tr>
                            <td><strong>Fecha de Venta:</strong></td>
                            <td>{{ devolucion.factura_original.fechaEmision|date:"d/m/Y H:i" }}</td>
                        </tr>
                        <tr>
                            <td><strong>Total Original:</strong></td>
                            <td class="text-success">$ {{ devolucion.factura_original.total|floatformat:2 }}</td>
                        </tr>
                        <tr>
                            <td><strong>Cliente:</strong></td>
                            <td>
                                {{ devolucion.factura_original.cliente_nombre|default:"Cliente Genérico" }}
                                {% if devolucion.factura_original.cliente_cedula %}
                                    <br><small class="text-muted">{{ devolucion.factura_original.cliente_cedula }}</small>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Estado de Factura:</strong></td>
                            <td>
                                <span class="badge bg-success">{{ devolucion.factura_original.get_estado_display }}</span>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Información del Cliente -->
    <div class="row">
        <div class="col-md-12">
            <div class="info-card card">
                <div class="card-header">
                    <i class="fas fa-user"></i> Información del Cliente
                </div>
                <div class="card-body">
                    {% if devolucion.factura_original.cliente_nombre %}
                    <div class="row">
                        <div class="col-md-4">
                            <strong>Nombre Completo:</strong><br>
                            {{ devolucion.factura_original.cliente_nombre }}
                        </div>
                        <div class="col-md-4">
                            <strong>Documento:</strong><br>
                            {{ devolucion.factura_original.cliente_cedula|default:"No disponible" }}
                        </div>
                        <div class="col-md-4">
                            <strong>Identificación:</strong><br>
                            Cliente ID: {{ devolucion.factura_original.idCliente|default:"No especificado" }}
                        </div>
                    </div>
                    {% else %}
                    <div class="text-muted text-center py-3">
                        <i class="fas fa-user-slash fa-2x mb-2"></i><br>
                        Cliente Genérico - Sin información específica
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Productos Devueltos -->
    <div class="row">
        <div class="col-md-12">
            <div class="info-card card">
                <div class="card-header">
                    <i class="fas fa-boxes"></i> Productos Devueltos
                    <span class="badge bg-danger ms-2">{{ devolucion.detalles.count }}</span>
                </div>
                <div class="card-body">
                    {% for detalle in devolucion.detalles.all %}
                    <div class="producto-devuelto">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <div>
                                    <strong>{{ detalle.detalle_factura.productoNombre|default:"Producto sin nombre" }}</strong>
                                    <br>
                                    <small class="text-muted">
                                        ID Producto: {{ detalle.detalle_factura.idProducto }}
                                    </small>
                                </div>
                            </div>
                            <div class="col-md-2 text-center">
                                <div class="text-muted">Cantidad Devuelta</div>
                                <strong class="text-danger">{{ detalle.cantidad_devuelta }}</strong>
                            </div>
                            <div class="col-md-2 text-center">
                                <div class="text-muted">Precio Unitario</div>
                                <strong>$ {{ detalle.detalle_factura.precioUnitario|floatformat:2 }}</strong>
                            </div>
                            <div class="col-md-2 text-center">
                                <div class="text-muted">Subtotal Devuelto</div>
                                <strong class="text-success">$ {{ detalle.total_devuelto|floatformat:2 }}</strong>
                            </div>
                        </div>
                        
                        <!-- Información adicional del producto -->
                        <div class="row mt-2">
                            <div class="col-md-12">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle"></i>
                                    Cantidad original en factura: {{ detalle.detalle_factura.cantidad }} | 
                                    Precio original: $ {{ detalle.detalle_factura.precioUnitario|floatformat:2 }}
                                </small>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="text-center py-4 text-muted">
                        <i class="fas fa-box-open fa-3x mb-3"></i>
                        <p>No hay productos en esta devolución</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Timeline de la Devolución -->
    <div class="row">
        <div class="col-md-6">
            <div class="info-card card">
                <div class="card-header">
                    <i class="fas fa-clock"></i> Cronología
                </div>
                <div class="card-body">
                    <div class="timeline-item">
                        <strong>Venta Original Realizada</strong>
                        <br>
                        <small class="text-muted">
                            {{ devolucion.venta_original.fecha|date:"d/m/Y H:i" }}
                            por {{ devolucion.venta_original.vendedor.get_full_name|default:devolucion.venta_original.vendedor.username }}
                        </small>
                    </div>
                    
                    <div class="timeline-item">
                        <strong>Devolución Procesada</strong>
                        <br>
                        <small class="text-muted">
                            {{ devolucion.fecha|date:"d/m/Y H:i" }}
                            por {{ devolucion.usuario.get_full_name|default:devolucion.usuario.username }}
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Datos Técnicos -->
        <div class="col-md-6">
            <div class="info-card card">
                <div class="card-header">
                    <i class="fas fa-cog"></i> Datos Técnicos
                </div>
                <div class="card-body">
                    <div class="datos-tecnicos">
                        <strong>ID Devolución:</strong> {{ devolucion.id }}<br>
                        <strong>ID Venta Original:</strong> {{ devolucion.venta_original.id }}<br>
                        <strong>Usuario ID:</strong> {{ devolucion.usuario.id }}<br>
                        <strong>Cantidad de Items:</strong> {{ devolucion.detalles.count }}<br>
                        <strong>Timestamp:</strong> {{ devolucion.fecha|date:"Y-m-d H:i:s" }}<br>
                        {% if devolucion.venta_original.idCaja %}
                        <strong>Caja Original:</strong> {{ devolucion.venta_original.idCaja }}<br>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Resumen Final -->
    <div class="row">
        <div class="col-md-12">
            <div class="info-card card">
                <div class="card-header">
                    <i class="fas fa-calculator"></i> Resumen Financiero
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-3">
                            <h5 class="text-primary">Total Venta Original</h5>
                            <h4>L. {{ devolucion.venta_original.total|floatformat:2 }}</h4>
                        </div>
                        <div class="col-md-3">
                            <h5 class="text-danger">Total Devuelto</h5>
                            <h4>L. {{ devolucion.total_devolucion|floatformat:2 }}</h4>
                        </div>
                        <div class="col-md-3">
                            <h5 class="text-success">Saldo Neto</h5>
                            <h4>L. {{ devolucion.factura_original.total|add:devolucion.total_devolucion|floatformat:2 }}</h4>
                        </div>
                        <div class="col-md-3">
                            <h5 class="text-info">% Devuelto</h5>
                            <h4>{% widthratio devolucion.total_devolucion devolucion.factura_original.total 100 %}%</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function imprimirDevolucion() {
    // Crear ventana de impresión
    const contenido = `
        <html>
        <head>
            <title>Devolución {{ devolucion.numero_devolucion }}</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; }
                .info-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                .info-table th, .info-table td { padding: 8px; border: 1px solid #ddd; text-align: left; }
                .info-table th { background-color: #f5f5f5; }
                .productos-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                .productos-table th, .productos-table td { padding: 8px; border: 1px solid #ddd; text-align: left; }
                .productos-table th { background-color: #f5f5f5; }
                .total { text-align: right; font-size: 1.2em; font-weight: bold; }
                @media print { .no-print { display: none; } }
            </style>
        </head>
        <body>
            <div class="header">
                <h2>COMPROBANTE DE DEVOLUCIÓN</h2>
                <p>{{ devolucion.numero_devolucion }}</p>
                <p>Fecha: {{ devolucion.fecha|date:"d/m/Y H:i" }}</p>
            </div>
            
            <table class="info-table">
                <tr>
                    <th>Factura Original:</th>
                    <td>{{ devolucion.factura_original.numeroFactura }}</td>
                    <th>Fecha Venta:</th>
                    <td>{{ devolucion.factura_original.fechaEmision|date:"d/m/Y H:i" }}</td>
                </tr>
                <tr>
                    <th>Cliente:</th>
                    <td colspan="3">
                        {% if devolucion.factura_original.cliente_nombre %}
                            {{ devolucion.factura_original.cliente_nombre }} - {{ devolucion.factura_original.cliente_cedula|default:"Sin documento" }}
                        {% else %}
                            Cliente Genérico
                        {% endif %}
                    </td>
                </tr>
                <tr>
                    <th>Motivo:</th>
                    <td>{{ devolucion.get_motivo_display }}</td>
                    <th>Usuario:</th>
                    <td>{{ devolucion.usuario.get_full_name|default:devolucion.usuario.username }}</td>
                </tr>
            </table>
            
            <h3>Productos Devueltos:</h3>
            <table class="productos-table">
                <thead>
                    <tr>
                        <th>Código</th>
                        <th>Producto</th>
                        <th>Cantidad</th>
                        <th>Precio Unit.</th>
                        <th>Subtotal</th>
                    </tr>
                </thead>
                <tbody>
                    {% for detalle in devolucion.detalles.all %}
                    <tr>
                        <td>{{ detalle.detalle_factura.idProducto }}</td>
                        <td>{{ detalle.detalle_factura.productoNombre|default:"Producto sin nombre" }}</td>
                        <td>{{ detalle.cantidad_devuelta }}</td>
                        <td>L. {{ detalle.detalle_factura.precioUnitario|floatformat:2 }}</td>
                        <td>L. {{ detalle.total_devuelto|floatformat:2 }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            <div class="total">
                <p>TOTAL DEVUELTO: L. {{ devolucion.total_devolucion|floatformat:2 }}</p>
            </div>
            
            {% if devolucion.observaciones %}
            <p><strong>Observaciones:</strong> {{ devolucion.observaciones }}</p>
            {% endif %}
            
            <div style="margin-top: 50px; text-align: center;">
                <p>_______________________________</p>
                <p>Firma del Cliente</p>
            </div>
        </body>
        </html>
    `;
    
    const ventana = window.open('', '_blank', 'width=800,height=600');
    ventana.document.write(contenido);
    ventana.document.close();
    ventana.print();
}
</script>
{% endblock %}