{% extends 'base.html' %}
{% load static %}
{% load l10n %}

{% block title %}Punto de Venta - Sistema POS{% endblock %}

{% block extra_css %}
<style>
    /* Variables de color */
    :root {
        --primary-blue: #0066cc;
        --dark-blue: #003d7a;
        --light-blue: #e6f2ff;
        --success-green: #28a745;
        --warning-yellow: #ffc107;
        --danger-red: #dc3545;
        --gray-light: #f8f9fa;
        --gray-medium: #6c757d;
        --gray-dark: #343a40;
    }
    
    /* Reset y base para móviles */
    * {
        box-sizing: border-box;
    }
    
    body {
        overflow-x: hidden;
    }
    
    .container-fluid {
        padding-left: 10px;
        padding-right: 10px;
    }

    /* Header Principal con Información Fiscal */
    .pos-header {
        background: linear-gradient(135deg, var(--dark-blue) 0%, var(--primary-blue) 100%);
        color: white;
        padding: 15px 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .pos-header h4 {
        margin: 0;
        font-weight: 600;
    }

    .header-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
    }

    .info-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .info-label {
        font-size: 0.75rem;
        opacity: 0.9;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .info-value {
        font-size: 1rem;
        font-weight: 600;
    }

    /* Panel de Cliente Mejorado */
    .client-panel {
        background: white;
        border: 2px solid var(--primary-blue);
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
    }

    .client-search-enhanced {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .client-search-enhanced input {
        flex: 1;
        padding: 10px 15px;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        font-size: 1.1rem;
    }

    .client-search-enhanced input:focus {
        border-color: var(--primary-blue);
        box-shadow: 0 0 0 0.2rem rgba(0, 102, 204, 0.25);
    }

    .client-info-enhanced {
        margin-top: 10px;
        padding: 10px;
        background: var(--light-blue);
        border-radius: 8px;
        display: none;
    }

    .client-info-enhanced.active {
        display: block;
    }

    /* Panel de Precios Mejorado */
    .pricing-panel {
        background: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .price-options {
        display: flex;
        gap: 15px;
        justify-content: space-around;
    }

    .price-option {
        flex: 1;
        text-align: center;
        padding: 15px;
        border-radius: 8px;
        border: 2px solid #dee2e6;
        cursor: pointer;
        transition: all 0.3s;
    }

    .price-option:hover {
        border-color: var(--primary-blue);
        background: var(--light-blue);
    }

    .price-option.active {
        border-color: var(--primary-blue);
        background: var(--primary-blue);
        color: white;
    }

    .price-option .label {
        font-size: 0.85rem;
        margin-bottom: 5px;
    }

    .price-option .amount {
        font-size: 1.5rem;
        font-weight: 700;
    }

    /* Botones de Acción Rápida */
    .quick-actions {
        background: white;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .action-buttons {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 10px;
    }

    .action-btn {
        padding: 12px 10px;
        border-radius: 8px;
        border: 2px solid #dee2e6;
        background: white;
        cursor: pointer;
        transition: all 0.3s;
        text-align: center;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .action-btn i {
        display: block;
        font-size: 1.5rem;
        margin-bottom: 5px;
    }

    .action-btn:hover {
        background: var(--primary-blue);
        color: white;
        border-color: var(--primary-blue);
        transform: translateY(-2px);
    }

    .action-btn .shortcut {
        display: block;
        font-size: 0.7rem;
        opacity: 0.7;
        margin-top: 3px;
    }

    /* Tabla de Productos Mejorada */
    .products-table-container {
        background: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        overflow-x: auto;
    }

    .products-table {
        width: 100%;
        border-collapse: collapse;
    }

    .products-table thead {
        background: linear-gradient(135deg, var(--dark-blue) 0%, var(--primary-blue) 100%);
        color: white;
    }

    .products-table th {
        padding: 12px 10px;
        text-align: left;
        font-weight: 600;
        font-size: 0.85rem;
        white-space: nowrap;
    }

    .products-table tbody tr {
        border-bottom: 1px solid #dee2e6;
        transition: background 0.2s;
    }

    .products-table tbody tr:hover {
        background: var(--light-blue);
    }

    .products-table td {
        padding: 12px 10px;
        font-size: 0.9rem;
    }

    .products-table .product-name {
        font-weight: 600;
        color: var(--dark-blue);
    }

    .products-table .product-code {
        color: var(--gray-medium);
        font-size: 0.8rem;
    }

    .products-table input[type="number"] {
        width: 70px;
        padding: 5px 8px;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        text-align: center;
    }

    .products-table .btn-action {
        padding: 5px 10px;
        border-radius: 5px;
        border: none;
        cursor: pointer;
        font-size: 0.85rem;
        transition: all 0.2s;
    }

    .btn-edit {
        background: var(--warning-yellow);
        color: white;
    }

    .btn-delete {
        background: var(--danger-red);
        color: white;
        margin-left: 5px;
    }

    .btn-action:hover {
        transform: scale(1.1);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
    }

    /* Panel de Totales Mejorado */
    .totals-panel {
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .discount-section {
        background: var(--gray-light);
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
    }

    .discount-options {
        display: flex;
        gap: 10px;
        margin-top: 10px;
    }

    .discount-btn {
        flex: 1;
        padding: 8px;
        border: 2px solid #dee2e6;
        border-radius: 5px;
        background: white;
        cursor: pointer;
        transition: all 0.2s;
        font-weight: 600;
    }

    .discount-btn:hover,
    .discount-btn.active {
        background: var(--primary-blue);
        color: white;
        border-color: var(--primary-blue);
    }

    .totals-breakdown {
        margin: 15px 0;
    }

    .total-row {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        font-size: 1rem;
    }

    .total-row.subtotal {
        border-bottom: 1px solid #dee2e6;
    }

    .total-row.discount {
        color: var(--danger-red);
    }

    .total-row.tax {
        color: var(--gray-medium);
    }

    .total-row.final {
        border-top: 2px solid var(--dark-blue);
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--success-green);
        padding-top: 15px;
    }

    /* Panel de Pago Mejorado */
    .payment-panel {
        background: var(--gray-light);
        border-radius: 8px;
        padding: 15px;
        margin-top: 15px;
    }

    .payment-methods {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        margin-bottom: 15px;
    }

    .payment-method {
        padding: 12px;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        background: white;
        cursor: pointer;
        text-align: center;
        transition: all 0.2s;
    }

    .payment-method i {
        font-size: 1.5rem;
        display: block;
        margin-bottom: 5px;
    }

    .payment-method:hover,
    .payment-method.active {
        border-color: var(--primary-blue);
        background: var(--primary-blue);
        color: white;
    }

    .amount-input-group {
        margin-bottom: 15px;
    }

    .amount-input-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
    }

    .amount-input-group input {
        width: 100%;
        padding: 12px;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        font-size: 1.2rem;
        text-align: right;
    }

    .change-display {
        background: white;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
        margin-bottom: 15px;
    }

    .change-display .label {
        font-size: 0.9rem;
        color: var(--gray-medium);
        margin-bottom: 5px;
    }

    .change-display .amount {
        font-size: 2rem;
        font-weight: 700;
        color: var(--success-green);
    }

    /* Botones Principales de Acción */
    .main-actions {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
    }

    .btn-main {
        padding: 18px;
        border-radius: 8px;
        border: none;
        font-size: 1.1rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
    }

    .btn-main i {
        font-size: 1.3rem;
    }

    .btn-process {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        grid-column: 1 / -1;
    }

    .btn-process:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
    }

    .btn-process:disabled {
        background: var(--gray-medium);
        cursor: not-allowed;
        transform: none;
    }

    .btn-cancel {
        background: var(--gray-light);
        color: var(--gray-dark);
        border: 2px solid #dee2e6;
    }

    .btn-cancel:hover {
        background: var(--danger-red);
        color: white;
        border-color: var(--danger-red);
    }

    .btn-clear {
        background: var(--warning-yellow);
        color: var(--gray-dark);
    }

    .btn-clear:hover {
        background: #e0a800;
        color: white;
    }

    /* Búsqueda de Productos Mejorada */
    .product-search-enhanced {
        background: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .search-controls {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        flex-wrap: wrap;
    }

    .search-controls input {
        flex: 1 1 100%;
        min-width: 0;
        padding: 12px 15px;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        font-size: 1rem;
    }

    .search-controls select {
        flex: 1 1 calc(50% - 5px);
        min-width: 0;
        max-width: 100%;
        padding: 12px 15px;
        border: 2px solid #dee2e6;
        border-radius: 8px;
    }

    .search-controls input:focus,
    .search-controls select:focus {
        border-color: var(--primary-blue);
        outline: none;
    }

    /* Grid de Productos */
    .products-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
        max-height: 400px;
        overflow-y: auto;
        padding: 10px;
    }

    .product-card-enhanced {
        background: white;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        cursor: pointer;
        transition: all 0.3s;
    }

    .product-card-enhanced:hover {
        border-color: var(--primary-blue);
        transform: translateY(-5px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
    }

    .product-card-enhanced .name {
        font-weight: 600;
        margin-bottom: 5px;
        color: var(--dark-blue);
    }

    .product-card-enhanced .code {
        font-size: 0.8rem;
        color: var(--gray-medium);
        margin-bottom: 10px;
    }

    .product-card-enhanced .price {
        font-size: 1.3rem;
        font-weight: 700;
        color: var(--success-green);
        margin-bottom: 8px;
    }

    .product-card-enhanced .stock {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .stock-high {
        background: #d4edda;
        color: #155724;
    }

    .stock-low {
        background: #fff3cd;
        color: #856404;
    }

    .stock-none {
        background: #f8d7da;
        color: #721c24;
    }

    /* Sistema de Tabs Mejorado */
    .sales-tabs-enhanced {
        background: white;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .nav-tabs-enhanced {
        border: none;
        display: flex;
        gap: 5px;
    }

    .nav-tabs-enhanced .nav-item {
        margin: 0;
    }

    .nav-tabs-enhanced .nav-link {
        border: 2px solid #dee2e6;
        border-radius: 8px 8px 0 0;
        padding: 12px 20px;
        color: var(--gray-dark);
        font-weight: 600;
        position: relative;
        padding-right: 45px;
        transition: all 0.2s;
    }

    .nav-tabs-enhanced .nav-link:hover {
        background: var(--light-blue);
        border-color: var(--primary-blue);
    }

    .nav-tabs-enhanced .nav-link.active {
        background: linear-gradient(135deg, var(--dark-blue) 0%, var(--primary-blue) 100%);
        color: white;
        border-color: var(--primary-blue);
    }

    .nav-tabs-enhanced .badge {
        position: absolute;
        top: 5px;
        right: 35px;
        background: white;
        color: var(--primary-blue);
        padding: 3px 8px;
        border-radius: 10px;
        font-size: 0.7rem;
    }

    .nav-tabs-enhanced .nav-link.active .badge {
        background: var(--warning-yellow);
        color: var(--dark-blue);
    }

    .btn-close-tab-enhanced {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: inherit;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-close-tab-enhanced:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-50%) scale(1.1);
    }

    .btn-add-tab {
        background: var(--success-green);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 8px 8px 0 0;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-add-tab:hover {
        background: #218838;
        transform: translateY(-2px);
    }

    /* Indicador Offline Mejorado */
    .offline-indicator-enhanced {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
        padding: 15px 25px;
        border-radius: 10px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        animation: pulse-enhanced 2s infinite;
    }

    @keyframes pulse-enhanced {

        0%,
        100% {
            opacity: 1;
            transform: scale(1);
        }

        50% {
            opacity: 0.85;
            transform: scale(1.05);
        }
    }

    .offline-indicator-enhanced i {
        font-size: 1.5rem;
        animation: spin 3s linear infinite;
    }

    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    /* Responsive Mejorado */
    
    /* Tablets y pantallas medianas (992px - 1199px) */
    @media (max-width: 1199px) {
        .action-buttons {
            grid-template-columns: repeat(4, 1fr);
        }

        .products-grid {
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        }
        
        .pos-header {
            padding: 12px 15px;
        }
        
        .info-value {
            font-size: 0.9rem;
        }
    }

    /* Tablets pequeñas (768px - 991px) */
    @media (max-width: 991px) {
        .header-info {
            gap: 10px;
        }
        
        .info-group {
            flex: 1 1 calc(50% - 10px);
            min-width: 150px;
        }
        
        .action-buttons {
            grid-template-columns: repeat(3, 1fr);
        }
        
        .products-grid {
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        }
        
        /* Hacer que el carrito se muestre debajo en tablets */
        .row > .col-lg-7,
        .row > .col-lg-5 {
            flex: 0 0 100%;
            max-width: 100%;
        }
        
        .col-lg-5 {
            margin-top: 20px;
        }
    }

    /* Móviles y pantallas pequeñas (576px - 767px) */
    @media (max-width: 767px) {
        .container-fluid {
            padding-left: 5px;
            padding-right: 5px;
        }
        
        .pos-header {
            padding: 8px;
            margin-bottom: 10px;
            border-radius: 8px;
        }
        
        .pos-header h4 {
            font-size: 0.9rem;
            margin-bottom: 8px;
        }
        
        .header-info {
            flex-direction: column;
            gap: 4px;
        }
        
        .info-group {
            flex: 1 1 100%;
            flex-direction: row;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
        }
        
        .info-group:last-child {
            border-bottom: none;
        }
        
        .info-label {
            font-size: 0.65rem;
            flex-shrink: 0;
        }
        
        .info-value {
            font-size: 0.75rem;
            text-align: right;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .info-value i {
            font-size: 0.7rem;
            margin-right: 4px;
        }
        
        /* Tabs mejorados para móvil */
        .sales-tabs-enhanced {
            margin-bottom: 10px;
        }
        
        .nav-tabs-enhanced {
            overflow-x: auto;
            overflow-y: hidden;
            flex-wrap: nowrap;
            -webkit-overflow-scrolling: touch;
            margin-bottom: 0;
            border-bottom: 2px solid var(--primary-blue);
        }
        
        .nav-tabs-enhanced .nav-item {
            flex-shrink: 0;
        }
        
        .nav-link {
            font-size: 0.75rem;
            padding: 8px 12px;
            white-space: nowrap;
        }
        
        .nav-link i {
            font-size: 0.75rem;
            margin-right: 4px;
        }
        
        .nav-link .badge {
            font-size: 0.65rem;
            padding: 2px 4px;
        }
        
        .btn-add-tab {
            font-size: 0.75rem;
            padding: 8px 10px;
            white-space: nowrap;
        }
        
        .btn-add-tab i {
            font-size: 0.7rem;
        }

        /* Panel de cliente más compacto */
        .client-panel {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 8px;
        }
        
        .client-panel h6 {
            font-size: 0.85rem;
            margin-bottom: 8px;
        }
        
        .client-panel h6 i {
            font-size: 0.8rem;
        }
        
        .client-panel .badge {
            font-size: 0.65rem;
            padding: 3px 6px;
        }
        
        .client-search-enhanced {
            flex-direction: row;
            gap: 6px;
        }
        
        .client-search-enhanced input {
            font-size: 0.85rem;
            padding: 8px 10px;
            border-radius: 6px;
        }
        
        .client-search-enhanced .btn {
            padding: 8px 12px;
            font-size: 0.85rem;
        }
        
        .client-info-enhanced {
            padding: 8px;
            margin-top: 8px;
            font-size: 0.8rem;
        }

        /* Búsqueda de productos */
        .search-box-enhanced {
            margin-bottom: 10px;
        }
        
        .search-box-enhanced input {
            font-size: 0.85rem;
            padding: 8px 10px;
            border-radius: 6px;
        }
        
        .search-box-enhanced i {
            font-size: 0.9rem;
        }
        
        /* Filtros más compactos */
        .product-search-enhanced {
            padding: 10px;
            margin-bottom: 10px;
        }
        
        .search-controls {
            gap: 6px;
            margin-bottom: 10px;
        }
        
        .search-controls input {
            flex: 1 1 100%;
            font-size: 0.8rem;
            padding: 8px 10px;
            border-width: 1px;
        }
        
        .search-controls select {
            flex: 1 1 100%;
            max-width: 100%;
            font-size: 0.75rem;
            padding: 8px 10px;
            border-width: 1px;
        }

        /* Botones de acción más pequeños */
        .quick-actions {
            padding: 8px;
            margin-bottom: 10px;
        }
        
        .action-buttons {
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
        }

        .action-btn {
            padding: 6px 4px;
            font-size: 0.65rem;
            border-radius: 6px;
            min-height: 50px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .action-btn i {
            font-size: 1rem;
            margin-bottom: 2px;
        }
        
        .action-btn .shortcut {
            display: none;
        }

        /* Productos grid más compactos */
        .products-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
            max-height: 350px;
            padding: 5px;
        }

        .product-card-enhanced {
            padding: 8px;
            border-radius: 8px;
            min-height: 140px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .product-card-enhanced h6 {
            font-size: 0.72rem;
            line-height: 1.2;
            margin-bottom: 4px;
            max-height: 2.4em;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        
        .product-card-enhanced .text-muted {
            font-size: 0.65rem;
            margin-bottom: 3px;
        }
        
        .product-card-enhanced .price {
            font-size: 0.95rem;
            margin: 5px 0;
            font-weight: 700;
        }
        
        .product-card-enhanced .badge {
            font-size: 0.6rem;
            padding: 2px 5px;
            margin-top: 3px;
        }
        
        .product-card-enhanced .btn {
            font-size: 0.7rem;
            padding: 6px 8px;
            margin-top: 5px;
            width: 100%;
        }
        
        .product-card-enhanced .btn i {
            font-size: 0.75rem;
        }

        /* Tabla de carrito responsive */
        .products-table-container {
            padding: 8px;
            overflow-x: auto;
            margin-bottom: 10px;
        }
        
        .products-table {
            font-size: 0.7rem;
            min-width: 100%;
        }
        
        .products-table th,
        .products-table td {
            padding: 6px 3px;
            white-space: nowrap;
        }
        
        .products-table th {
            font-size: 0.65rem;
        }
        
        /* Ocultar columnas menos importantes en móvil */
        .products-table th:nth-child(2),
        .products-table td:nth-child(2) {
            display: none;
        }
        
        .products-table .product-name {
            font-size: 0.75rem;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .products-table input[type="number"] {
            width: 45px;
            padding: 3px;
            font-size: 0.75rem;
        }
        
        .products-table .btn-action {
            padding: 3px 6px;
            font-size: 0.7rem;
        }
        
        .products-table .btn-delete {
            margin-left: 2px;
        }

        /* Panel de precios en columna */
        .price-options {
            flex-direction: column;
            gap: 10px;
        }

        .price-option {
            padding: 12px;
        }
        
        .price-option .amount {
            font-size: 1.3rem;
        }

        /* Panel de totales más compacto */
        .totals-panel {
            padding: 10px;
            margin-top: 10px;
        }

        .discount-section {
            padding: 8px;
            margin-bottom: 10px;
        }
        
        .discount-section h6 {
            font-size: 0.8rem;
            margin-bottom: 6px;
        }

        .discount-options {
            flex-wrap: wrap;
            gap: 5px;
        }

        .discount-btn {
            flex: 1 1 calc(25% - 5px);
            min-width: 50px;
            padding: 5px 3px;
            font-size: 0.7rem;
        }
        
        .discount-section input {
            font-size: 0.8rem;
            padding: 5px 8px;
        }

        .total-row {
            font-size: 0.8rem;
            padding: 6px 0;
        }
        
        .total-row .fw-bold {
            font-size: 0.85rem;
        }

        .total-row.final {
            font-size: 1.1rem;
            padding-top: 10px;
        }

        /* Métodos de pago en 2 columnas */
        .payment-section h6 {
            font-size: 0.8rem;
            margin-bottom: 8px;
        }
        
        .payment-methods {
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
            margin-bottom: 10px;
        }

        .payment-method {
            padding: 8px 6px;
            font-size: 0.75rem;
            border-radius: 6px;
        }
        
        .payment-method i {
            font-size: 1.2rem;
            margin-bottom: 3px;
        }
        
        .payment-section input {
            font-size: 0.85rem;
            padding: 8px 10px;
        }
        
        .payment-section label {
            font-size: 0.75rem;
        }

        /* Botones principales más compactos */
        .main-actions {
            grid-template-columns: 1fr;
            gap: 8px;
            margin-top: 10px;
        }

        .btn-main {
            padding: 10px;
            font-size: 0.9rem;
            border-radius: 6px;
        }
        
        .btn-main i {
            font-size: 0.9rem;
        }
        
        /* Modales en móvil */
        .modal-dialog {
            margin: 0.5rem;
        }
        
        .modal-body {
            padding: 20px !important;
        }
    }

    /* Móviles muy pequeños (menos de 576px) */
    @media (max-width: 575px) {
        .pos-header h4 {
            font-size: 0.85rem;
        }
        
        .info-value {
            font-size: 0.7rem;
        }
        
        .action-buttons {
            grid-template-columns: repeat(3, 1fr);
        }
        
        /* Selectores en columna completa */
        .search-controls select {
            flex: 1 1 100%;
        }
        
        .products-grid {
            grid-template-columns: repeat(2, 1fr);
            max-height: 300px;
            gap: 5px;
        }
        
        .product-card-enhanced {
            padding: 6px;
            min-height: 130px;
        }
        
        .product-card-enhanced h6 {
            font-size: 0.68rem;
        }
        
        .product-card-enhanced .price {
            font-size: 0.85rem;
        }
        
        .discount-btn {
            flex: 1 1 calc(33.333% - 5px);
            font-size: 0.65rem;
            padding: 4px 2px;
        }
        
        .total-row.final {
            font-size: 1rem;
        }
        
        /* Stack de inputs en móvil pequeño */
        .input-group .form-control {
            font-size: 0.8rem;
        }
        
        /* Modal más compacto */
        .modal-body {
            padding: 15px !important;
        }
        
        .modal-title {
            font-size: 0.9rem;
        }
    }
    
    /* Landscape móvil - pantalla horizontal */
    @media (max-width: 991px) and (orientation: landscape) {
        .products-grid {
            max-height: 200px;
        }
        
        .pos-header {
            padding: 6px 8px;
        }
        
        .info-group {
            flex: 1 1 calc(50% - 5px);
            padding: 3px 0;
        }
        
        .info-value {
            font-size: 0.7rem;
        }
        
        .client-panel,
        .quick-actions,
        .totals-panel {
            padding: 8px;
        }
    }
    
    /* Ajuste específico para viewport muy estrecho */
    @media (max-width: 380px) {
        .container-fluid {
            padding-left: 3px;
            padding-right: 3px;
        }
        
        .pos-header {
            padding: 6px;
            margin-bottom: 8px;
        }
        
        .pos-header h4 {
            font-size: 0.8rem;
        }
        
        .nav-link {
            font-size: 0.7rem;
            padding: 6px 8px;
        }
        
        .btn-add-tab {
            font-size: 0.7rem;
            padding: 6px 8px;
        }
        
        .action-buttons {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .action-btn {
            font-size: 0.6rem;
            padding: 5px 3px;
            min-height: 45px;
        }
        
        .action-btn i {
            font-size: 0.9rem;
        }
        
        .products-grid {
            grid-template-columns: 1fr;
        }
        
        .product-card-enhanced h6 {
            font-size: 0.75rem;
        }
    }

    /* Scrollbar Personalizada */
    .products-grid::-webkit-scrollbar,
    .products-table-container::-webkit-scrollbar {
        width: 8px;
        height: 8px;
    }

    .products-grid::-webkit-scrollbar-track,
    .products-table-container::-webkit-scrollbar-track {
        background: var(--gray-light);
        border-radius: 10px;
    }

    .products-grid::-webkit-scrollbar-thumb,
    .products-table-container::-webkit-scrollbar-thumb {
        background: var(--primary-blue);
        border-radius: 10px;
    }

    .products-grid::-webkit-scrollbar-thumb:hover,
    .products-table-container::-webkit-scrollbar-thumb:hover {
        background: var(--dark-blue);
    }

    /* Animaciones de entrada */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .product-card-enhanced,
    .action-btn,
    .price-option {
        animation: fadeInUp 0.3s ease-out;
    }

    /* Estado de carga */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
    }

    .loading-spinner {
        width: 60px;
        height: 60px;
        border: 5px solid rgba(255, 255, 255, 0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    /* Notificaciones toast */
    .toast-notification {
        position: fixed;
        top: 80px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        padding: 15px 20px;
        animation: slideInRight 0.3s ease-out;
    }

    @keyframes slideInRight {
        from {
            transform: translateX(400px);
            opacity: 0;
        }

        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @keyframes slideOutRight {
        from {
            transform: translateX(0);
            opacity: 1;
        }

        to {
            transform: translateX(400px);
            opacity: 0;
        }
    }

    .toast-success {
        border-left: 4px solid var(--success-green);
    }

    .toast-error {
        border-left: 4px solid var(--danger-red);
    }

    .toast-warning {
        border-left: 4px solid var(--warning-yellow);
    }

    .toast-info {
        border-left: 4px solid var(--primary-blue);
    }
    
    /* Estilos adicionales para productos */
    #search-loading {
        display: none;
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
    }
</style>
{% endblock %}

{% block content %}
<!-- Indicador de modo offline mejorado -->
{% if modo_offline %}
<div class="offline-indicator-enhanced">
    <i class="fas fa-wifi-slash"></i>
    <div>
        <strong>MODO OFFLINE</strong>
        <div style="font-size: 0.85rem; opacity: 0.9;">Sin conexión al servidor</div>
    </div>
</div>
{% endif %}

<!-- Header Principal con Información Fiscal -->
<div class="pos-header">
    <div class="header-info">
        <div class="info-group">
            <div class="info-label">Establecimiento</div>
            <div class="info-value">
                <i class="fas fa-store me-2"></i>
                {{ empresa.nombre_comercial|upper }}
            </div>
        </div>

        <div class="info-group">
            <div class="info-label">Ambiente SRI</div>
            <div class="info-value">
                <i class="fas fa-shield-alt me-2"></i>
                PRODUCCIÓN
            </div>
        </div>

        <div class="info-group">
            <div class="info-label">Fecha de Emisión</div>
            <div class="info-value">
                <i class="fas fa-calendar-alt me-2"></i>
                <span id="current-date"></span>
            </div>
        </div>

        <div class="info-group">
            <div class="info-label">Usuario</div>
            <div class="info-value">
                <i class="fas fa-user me-2"></i>
                {% if request.user.first_name or request.user.last_name %}
                    {{ request.user.get_full_name|title }}
                {% else %}
                    {{ request.user.username|upper }}
                {% endif %}
            </div>
        </div>

        <div class="info-group">
            <div class="info-label">Estado</div>
            <div class="info-value">
                <i class="fas fa-circle me-2" style="color: #28a745; font-size: 0.7rem;"></i>
                ONLINE
            </div>
        </div>
    </div>
</div>

<!-- Sistema de Tabs Mejorado -->
<div class="sales-tabs-enhanced">
    <ul class="nav nav-tabs-enhanced" role="tablist">
        <li class="nav-item" role="presentation">
            <a class="nav-link active position-relative" href="#venta1" data-bs-toggle="tab"
                onclick="switchToTab('venta1')">
                <i class="fas fa-shopping-cart me-2"></i>
                Venta 1
                <span class="badge" id="badge-venta1">0</span>
                <button type="button" class="btn-close-tab-enhanced"
                    onclick="closeTab('venta1'); event.stopPropagation();" title="Cerrar tab" style="display: none;">
                    <i class="fas fa-times"></i>
                </button>
            </a>
        </li>
        <li class="nav-item">
            <button class="btn-add-tab" onclick="createNewTab()" title="Nueva venta (Ctrl+N)">
                <i class="fas fa-plus me-2"></i>
                Nueva Venta
            </button>
        </li>
    </ul>
</div>

{% csrf_token %}

<!-- Contenido de las Tabs -->
<div class="tab-content">
    <div class="tab-pane fade show active" id="venta1" role="tabpanel">
        <div class="row">
            <!-- Columna Izquierda: Búsqueda y Productos -->
            <div class="col-lg-7">

                <!-- Panel de Cliente -->
                <div class="client-panel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0">
                            <i class="fas fa-user-circle me-2"></i>
                            Datos del Cliente
                        </h6>
                        <span class="badge bg-primary">CONSUMIDOR FINAL</span>
                    </div>

                    <div class="client-search-enhanced">
                        <input type="text" id="cliente-search" class="form-control"
                            placeholder="Buscar cliente por cédula, RUC o nombre..." autocomplete="off">
                        <button class="btn btn-outline-secondary" type="button" id="clear-client"
                            title="Limpiar cliente">
                            <i class="fas fa-times"></i>
                        </button>
                        <button class="btn btn-primary" type="button" title="Nuevo cliente" onclick="abrirModalNuevoCliente()">
                            <i class="fas fa-user-plus"></i>
                        </button>
                    </div>

                    <div class="client-info-enhanced" id="client-info">
                        <div class="row">
                            <div class="col-md-8">
                                <strong id="client-name"></strong><br>
                                <small class="text-muted">
                                    <i class="fas fa-id-card me-1"></i>
                                    <span id="client-document"></span>
                                </small>
                            </div>
                            <div class="col-md-4 text-end">
                                <span class="badge bg-success">Cliente Verificado</span>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="cliente-id" name="cliente_id" value="">
                </div>

                <!-- Botones de Acción Rápida -->
                <div class="quick-actions">
                    <h6 class="mb-3">
                        <i class="fas fa-bolt me-2"></i>
                        Acciones Rápidas
                    </h6>
                    <div class="action-buttons">
                        <button class="action-btn" onclick="window.location.href='{% url 'caja:cerrar' %}'">
                            <i class="fas fa-cash-register"></i>
                            Cerrar Caja
                            <span class="shortcut">F2</span>
                        </button>
                        <button class="action-btn" onclick="showInvoices()">
                            <i class="fas fa-file-invoice"></i>
                            Facturas
                            <span class="shortcut">F3</span>
                        </button>
                        <button class="action-btn" onclick="showPayments()">
                            <i class="fas fa-money-bill-wave"></i>
                            Pagos
                            <span class="shortcut">F4</span>
                        </button>
                        <button class="action-btn" onclick="showDiscounts()">
                            <i class="fas fa-percent"></i>
                            Descuentos
                            <span class="shortcut">F5</span>
                        </button>
                        <button class="action-btn" onclick="showKardex()">
                            <i class="fas fa-clipboard-list"></i>
                            Kardex
                            <span class="shortcut">F6</span>
                        </button>
                        <button class="action-btn" onclick="focusProductSearch()">
                            <i class="fas fa-search"></i>
                            Buscar
                            <span class="shortcut">F7</span>
                        </button>
                        <button class="action-btn" onclick="showRecharges()">
                            <i class="fas fa-mobile-alt"></i>
                            Recargas
                            <span class="shortcut">F8</span>
                        </button>
                        <button class="action-btn" onclick="showDocuments()">
                            <i class="fas fa-folder-open"></i>
                            Documentos
                            <span class="shortcut">F9</span>
                        </button>
                    </div>
                </div><!-- Búsqueda de Productos -->
                <div class="product-search-enhanced">
                    <h6 class="mb-3">
                        <i class="fas fa-boxes me-2"></i>
                        Buscar Productos
                    </h6>
                    <div class="search-controls" style="position: relative;">
                        <input type="text" id="search-products" placeholder="Buscar por nombre, código o categoría..."
                            autocomplete="off">
                        <div id="search-loading" style="position: absolute; right: 320px; top: 50%; transform: translateY(-50%); display: none;">
                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                <span class="visually-hidden">Buscando...</span>
                            </div>
                        </div>
                        <select id="filter-category">
                            <option value="">Todas las categorías</option>
                            {% for categoria in categorias %}
                            <option value="{{ categoria.id }}">{{ categoria.nombre }}</option>
                            {% endfor %}
                        </select>
                        <select id="filter-brand">
                            <option value="">Todas las marcas</option>
                        </select>
                    </div>
                    <div class="products-grid" id="products-grid">
                        {% for producto in productos %}
                        <div class="product-card-enhanced" 
                            data-product-id="{{ producto.id }}"
                            data-product-name="{{ producto.nombre|escapejs }}"
                            data-product-price="{% if producto.precioVenta %}{{ producto.precioVenta|stringformat:'.2f' }}{% else %}0.00{% endif %}"
                            data-product-stock="{{ producto.stock|default:0 }}"
                            data-category-id="{% if producto.idCategoria %}{{ producto.idCategoria }}{% else %}{% endif %}"
                            data-name="{{ producto.nombre|lower }}"
                            data-code="{{ producto.codigoPrincipal }}"
                            onclick="addToCartFromElement(this)">
                            <div class="name">{{ producto.nombre }}</div>
                            <div class="code">Cód: {{ producto.codigoPrincipal }}</div>
                            {% if producto.tiene_ubicacion %}
                            <div class="ubicacion" style="font-size: 0.75rem; color: #17a2b8; margin: 2px 0;">
                                <i class="fas fa-map-marker-alt"></i> {{ producto.ubicacion }}
                            </div>
                            {% else %}
                            <div class="ubicacion" style="font-size: 0.75rem; color: #6c757d; margin: 2px 0;">
                                <i class="fas fa-question-circle"></i> Sin ubicar
                            </div>
                            {% endif %}
                            <div class="price">$ <span class="price-value">{% if producto.precioVenta %}{{ producto.precioVenta|floatformat:2 }}{% else %}0.00{% endif %}</span></div>
                            <span class="stock {% if producto.stock > 10 %}stock-high{% elif producto.stock > 0 %}stock-low{% else %}stock-none{% endif %}">
                                Stock: {{ producto.stock|default:0 }}
                            </span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            <!-- Columna Derecha: Carrito y Totales -->
            <div class="col-lg-5">
                <!-- Panel de Precios -->
                <div class="pricing-panel">
                    <h6 class="mb-3">
                        <i class="fas fa-dollar-sign me-2"></i>
                        Tipo de Precio
                    </h6>
                    <div class="price-options">
                        <div class="price-option active" data-price-type="normal">
                            <div class="label">PRECIO</div>
                            <div class="amount" id="price-normal">$ <span id="total-preview">0.00</span></div>
                        </div>
                        <div class="price-option" data-price-type="efectivo">
                            <div class="label">PRECIO EFE</div>
                            <div class="amount" id="price-efectivo">$ <span id="total-efectivo-preview">0.00</span>
                            </div>
                        </div>
                        <div class="price-option" data-price-type="tarjeta">
                            <div class="label">PRECIO TAR</div>
                            <div class="amount" id="price-tarjeta">$ <span id="total-tarjeta-preview">0.00</span></div>
                        </div>
                    </div>
                </div>
                <!-- Tabla de Productos en Carrito -->
                <div class="products-table-container">
                    <h6 class="mb-3">
                        <i class="fas fa-shopping-cart me-2"></i>
                        Productos en Carrito
                    </h6>
                    <div id="cart-items-table">
                        <table class="products-table">
                            <thead>
                                <tr>
                                    <th>N°</th>
                                    <th>Código</th>
                                    <th>Producto/Item</th>
                                    <th>Cant</th>
                                    <th>Precio</th>
                                    <th>P.Final</th>
                                    <th>%</th>
                                    <th>Desc%</th>
                                    <th>IVA</th>
                                    <th>Subtotal</th>
                                    <th>Total</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="cart-items-body">
                                <tr>
                                    <td colspan="12" class="text-center text-muted py-4">
                                        <i class="fas fa-shopping-cart fa-3x mb-3"></i>
                                        <p>Carrito vacío</p>
                                        <small>Seleccione productos para agregar</small>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- Panel de Totales -->
                <div class="totals-panel">
                    <!-- Descuentos Fijos -->
                    <div class="discount-section">
                        <h6 class="mb-2">
                            <i class="fas fa-tags me-2"></i>
                            Descuentos Fijos
                        </h6>
                        <div class="discount-options">
                            <button class="discount-btn" data-discount="0" onclick="applyDiscount(0)">Sin
                                descuento</button>
                            <button class="discount-btn" data-discount="20" onclick="applyDiscount(20)">20%</button>
                            <button class="discount-btn" data-discount="30" onclick="applyDiscount(30)">30%</button>
                            <button class="discount-btn" data-discount="40" onclick="applyDiscount(40)">40%</button>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">Descuento personalizado:</small>
                            <input type="number" class="form-control form-control-sm" id="custom-discount"
                                placeholder="0%" min="0" max="100" step="1" onchange="applyDiscount(this.value)">
                        </div>
                    </div>
                    <!-- Desglose de Totales -->
                    <div class="totals-breakdown">
                        <div class="total-row subtotal">
                            <span>Subtotal:</span>
                            <strong id="subtotal-display">$ 0.00</strong>
                        </div>
                        <div class="total-row discount">
                            <span>Descuento (<span id="discount-percent">0</span>%):</span>
                            <strong id="discount-display">$ 0.00</strong>
                        </div>
                        <div class="total-row">
                            <span>Base Imponible:</span>
                            <strong id="base-imponible">$ 0.00</strong>
                        </div>
                        <div class="total-row tax">
                            <span>IVA (15%):</span>
                            <strong id="tax-display">$ 0.00</strong>
                        </div>
                        <div class="total-row final">
                            <span>TOTAL A PAGAR:</span>
                            <strong id="total-display">$ 0.00</strong>
                        </div>
                    </div>
                    <!-- Panel de Pago -->
                    <div class="payment-panel">
                        <h6 class="mb-3">
                            <i class="fas fa-credit-card me-2"></i>
                            Forma de Pago
                        </h6>
                        <div class="payment-methods">
                            <div class="payment-method active" data-method="efectivo"
                                onclick="selectPaymentMethod('efectivo')">
                                <i class="fas fa-money-bill-wave"></i>
                                <div>Efectivo</div>
                            </div>
                            <div class="payment-method" data-method="tarjeta" onclick="selectPaymentMethod('tarjeta')">
                                <i class="fas fa-credit-card"></i>
                                <div>Tarjeta</div>
                            </div>
                            <div class="payment-method" data-method="transferencia"
                                onclick="selectPaymentMethod('transferencia')">
                                <i class="fas fa-exchange-alt"></i>
                                <div>Transfer.</div>
                            </div>
                        </div>
                        <div class="amount-input-group">
                            <label>
                                <i class="fas fa-hand-holding-usd me-2"></i>
                                Monto Recibido:
                            </label>
                            <input type="number" id="monto-recibido" class="form-control" step="0.01" placeholder="0.00"
                                oninput="calculateChange()" onkeyup="calculateChange()">
                        </div>
                        <div class="change-display">
                            <div class="label">Cambio:</div>
                            <div class="amount" id="cambio-display">$ 0.00</div>
                        </div>
                    </div>
                    <!-- Botones Principales -->
                    <div class="main-actions">
                        <button class="btn-main btn-process" onclick="procesarVenta()" id="btn-procesar" disabled>
                            <i class="fas fa-cash-register"></i>
                            PROCESAR VENTA (F11)
                        </button>
                        <button class="btn-main btn-clear" onclick="clearCart()">
                            <i class="fas fa-broom"></i>
                            Limpiar
                        </button>
                        <button class="btn-main btn-cancel" onclick="cancelSale()">
                            <i class="fas fa-times-circle"></i>
                            Cancelar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div><!-- Modal de confirmación de venta -->
<div class="modal fade" id="ventaModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-check-circle me-2"></i>
                    Venta Procesada Exitosamente
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-4">
                    <i class="fas fa-check-circle fa-5x text-success mb-3"></i>
                    <h3>¡Venta Realizada!</h3>
                    <div class="alert alert-info mt-3">
                        <div class="row">
                            <div class="col-md-6">
                                <strong>Número de Factura:</strong><br>
                                <span class="h4" id="numero-venta"></span>
                            </div>
                            <div class="col-md-6">
                                <strong>Total:</strong><br>
                                <span class="h4 text-success" id="total-venta"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Información de Facturación Electrónica -->
                <div id="json-info" style="display: none;">
                    <div class="alert alert-primary">
                        <h6>
                            <i class="fas fa-file-code me-2"></i>
                            Facturación Electrónica
                        </h6>
                        <p class="mb-0">JSON generado para envío al SRI</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div class="row w-100">
                    <div class="col-md-3 mb-2">
                        <button type="button" class="btn btn-primary w-100" onclick="imprimirTicketTermico()">
                            <i class="fas fa-print"></i> Ticket Térmico
                        </button>
                    </div>
                    <div class="col-md-3 mb-2">
                        <button type="button" class="btn btn-success w-100" onclick="descargarJSON()">
                            <i class="fas fa-file-download"></i> JSON SRI
                        </button>
                    </div>
                    <div class="col-md-3 mb-2">
                        <button type="button" class="btn btn-info w-100" onclick="imprimirTicket()">
                            <i class="fas fa-receipt"></i> Ticket Normal
                        </button>
                    </div>
                    <div class="col-md-3 mb-2">
                        <button type="button" class="btn btn-secondary w-100" data-bs-dismiss="modal"
                            onclick="nuevaVenta()">
                            <i class="fas fa-plus"></i> Nueva Venta
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{{ productos|json_script:"productos-data" }}
{{ clientes|json_script:"clientes-data" }}
{{ categorias|json_script:"categorias-data" }}

<!-- Modal para editar cantidad de producto -->
<div class="modal fade" id="editQuantityModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 15px; overflow: hidden;">
            <div class="modal-header" style="background: linear-gradient(135deg, #0066cc 0%, #003d7a 100%); color: white; border: none;">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>
                    Editar Cantidad
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" style="padding: 30px;">
                <div class="text-center mb-4">
                    <div style="width: 80px; height: 80px; margin: 0 auto; background: #e6f2ff; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-boxes" style="font-size: 2.5rem; color: #0066cc;"></i>
                    </div>
                    <h6 class="mt-3 mb-1" id="edit-product-name" style="color: #212529; font-weight: 600;">Producto</h6>
                    <small class="text-muted">Stock disponible: <span id="edit-product-stock" class="fw-bold text-success">0</span></small>
                </div>
                
                <div class="mb-3">
                    <label for="edit-quantity-input" class="form-label fw-bold">
                        <i class="fas fa-hashtag me-1"></i>
                        Nueva Cantidad:
                    </label>
                    <div class="input-group input-group-lg">
                        <button class="btn btn-outline-secondary" type="button" onclick="adjustEditQuantity(-1)">
                            <i class="fas fa-minus"></i>
                        </button>
                        <input type="number" 
                               class="form-control text-center" 
                               id="edit-quantity-input" 
                               min="1" 
                               value="1"
                               style="font-size: 1.5rem; font-weight: 700; border-left: none; border-right: none;">
                        <button class="btn btn-outline-secondary" type="button" onclick="adjustEditQuantity(1)">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <small class="text-muted mt-1 d-block">Use los botones o escriba la cantidad directamente</small>
                </div>
                
                <div class="alert alert-info" style="background: #d1ecf1; border: none; border-left: 4px solid #0066cc;">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Sugerencia:</strong> Puede usar las teclas ↑ y ↓ para ajustar la cantidad
                </div>
            </div>
            <div class="modal-footer" style="border: none; padding: 20px 30px; background: #f8f9fa;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="padding: 10px 20px;">
                    <i class="fas fa-times me-2"></i>
                    Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="saveEditQuantity()" style="padding: 10px 30px; background: linear-gradient(135deg, #0066cc 0%, #003d7a 100%); border: none;">
                    <i class="fas fa-check me-2"></i>
                    Guardar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirmación Universal -->
<div class="modal fade" id="confirmModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 15px; overflow: hidden; border: none;">
            <div class="modal-header" id="confirm-header" style="border: none; padding: 25px 30px;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div id="confirm-icon-container" style="width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                        <i id="confirm-icon" style="font-size: 1.8rem;"></i>
                    </div>
                    <h5 class="modal-title mb-0" id="confirm-title">Confirmación</h5>
                </div>
            </div>
            <div class="modal-body" style="padding: 20px 30px 30px;">
                <p id="confirm-message" style="font-size: 1.05rem; color: #495057; margin: 0;"></p>
            </div>
            <div class="modal-footer" style="border: none; padding: 0 30px 25px; gap: 10px;">
                <button type="button" class="btn btn-secondary" id="confirm-cancel-btn" style="padding: 10px 25px; border-radius: 8px;">
                    <i class="fas fa-times me-2"></i>
                    <span id="confirm-cancel-text">Cancelar</span>
                </button>
                <button type="button" class="btn btn-primary" id="confirm-ok-btn" style="padding: 10px 30px; border-radius: 8px;">
                    <i class="fas fa-check me-2"></i>
                    <span id="confirm-ok-text">Aceptar</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para crear nuevo cliente -->
<div class="modal fade" id="modalNuevoCliente" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user-plus me-2"></i>
                    Nuevo Cliente
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modal-cliente-body">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="mt-2">Cargando formulario...</p>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/product-search.js' %}"></script>
<script>
    // ============================================
    // VARIABLES GLOBALES Y CONFIGURACIÓN
    // ============================================

    // Sistema de múltiples carritos para tabs
    let carts = {};
    let currentTabId = 'venta1';
    let tabCounter = 1;
    let ultimaVenta = {};
    let currentDiscount = 0;
    let selectedPaymentMethod = 'efectivo';

    // Inicializar el primer carrito
    carts[currentTabId] = {
        items: [],
        total: 0,
        subtotal: 0,
        discount: 0,
        tax: 0,
        cliente: null,
        cliente_id: null,
        cliente_nombre: null,
        cliente_documento: null
    };

    // ============================================
    // FUNCIONES DE GESTIÓN DE CARRITOS
    // ============================================

    function getCurrentCart() {
        if (!carts[currentTabId]) {
            carts[currentTabId] = {
                items: [],
                total: 0,
                subtotal: 0,
                discount: 0,
                tax: 0,
                cliente: null
            };
        }
        return carts[currentTabId];
    }

 function createNewTab() {
        tabCounter++;
        const newTabId = `venta${tabCounter}`;

        // Crear el tab en la navegación
        const tabNav = document.querySelector('.nav-tabs-enhanced');
        const newTabItem = document.createElement('li');
        newTabItem.className = 'nav-item';
        newTabItem.innerHTML = `
        <a class="nav-link position-relative" href="#${newTabId}" data-bs-toggle="tab" onclick="switchToTab('${newTabId}')">
            <i class="fas fa-shopping-cart me-2"></i>
            Venta ${tabCounter}
            <span class="badge" id="badge-${newTabId}">0</span>
            <button type="button" class="btn-close-tab-enhanced" onclick="closeTab('${newTabId}'); event.stopPropagation();" title="Cerrar tab">
                <i class="fas fa-times"></i>
            </button>
        </a>
    `;

        // Insertar antes del botón de nuevo tab
        const newTabButton = document.querySelector('.btn-add-tab').parentElement;
        tabNav.insertBefore(newTabItem, newTabButton);

        // Crear el contenido del tab (clonar el contenido de venta1)
        const tabContent = document.querySelector('.tab-content');
        const originalContent = document.getElementById('venta1');
        const newTabContent = originalContent.cloneNode(true);
        
        // Actualizar el ID del nuevo contenido
        newTabContent.id = newTabId;
        newTabContent.classList.remove('show', 'active');
        
        // LIMPIAR el carrito visual del nuevo tab (es un clon)
        const cartBody = newTabContent.querySelector('#cart-items-body');
        if (cartBody) {
            cartBody.innerHTML = `
                <tr>
                    <td colspan="12" class="text-center text-muted py-4">
                        <i class="fas fa-shopping-cart fa-3x mb-3"></i>
                        <p>Carrito vacío</p>
                        <small>Seleccione productos para agregar</small>
                    </td>
                </tr>
            `;
        }
        
        // LIMPIAR los datos del cliente clonados
        const clienteInput = newTabContent.querySelector('[id^="cliente-seleccionado"]');
        if (clienteInput) clienteInput.value = '';
        
        const clienteInfo = newTabContent.querySelector('[id^="cliente-info"]');
        if (clienteInfo) clienteInfo.style.display = 'none';
        
        // Actualizar IDs de elementos importantes dentro del tab clonado
        updateTabElementIds(newTabContent, newTabId);
        
        // Volver a vincular los event listeners de los productos en el nuevo tab
        rebindProductCards(newTabContent, newTabId);
        
        // Agregar el nuevo contenido al contenedor de tabs
        tabContent.appendChild(newTabContent);

        // Inicializar carrito para el nuevo tab
        carts[newTabId] = {
            items: [],
            total: 0,
            subtotal: 0,
            discount: 0,
            tax: 0,
            cliente: null,
            cliente_id: null,
            cliente_nombre: null,
            cliente_documento: null
        };

        // Mostrar botones de cierre
        updateCloseButtonsVisibility();

        // Cambiar al nuevo tab
        switchToTab(newTabId);

        showToast('Nueva venta creada', 'success');
    }

    function rebindProductCards(tabElement, tabId) {
    const productCards = tabElement.querySelectorAll('.product-card-enhanced');
    
    console.log(`🔗 Vinculando ${productCards.length} productos al tab ${tabId}`);
    
    productCards.forEach(card => {
        // Remover el onclick anterior
        card.removeAttribute('onclick');
        
        // IMPORTANTE: Almacenar el tabId en el elemento
        card.setAttribute('data-tab-id', tabId);
        
        // Agregar nuevo event listener
        card.addEventListener('click', function(e) {
            e.stopPropagation();
            
            // Obtener el tab al que pertenece este producto
            const cardTabId = this.getAttribute('data-tab-id');
            
            console.log('🖱️ Click en producto');
            console.log('   Tab actual:', currentTabId);
            console.log('   Tab del producto:', cardTabId);
            
            // Guardar el tab actual
            const previousTabId = currentTabId;
            
            // Cambiar temporalmente al tab del producto para agregar al carrito correcto
            currentTabId = cardTabId;
            
            // Agregar producto
            addToCartFromElement(this);
            
            // CRUCIAL: Actualizar el panel de totales del tab correcto inmediatamente
            updateTotalsForTab(cardTabId);
            
            // Restaurar el tab anterior si es necesario
            setTimeout(() => {
                if (previousTabId !== cardTabId) {
                    currentTabId = previousTabId;
                    // Actualizar la vista del tab actual también
                    updateCartDisplay();
                    updateTotals();
                }
            }, 0);
        });
    });
}

function updateTotalsForTab(tabId) {
    const cart = carts[tabId];
    if (!cart) return;
    
    // Calcular subtotal
    const subtotal = cart.items.reduce((sum, item) => {
        return sum + (parseFloat(item.price) * parseInt(item.quantity));
    }, 0);
    
    // Calcular descuento
    const discountAmount = subtotal * (parseFloat(currentDiscount) / 100);
    
    // Base imponible
    const baseImponible = subtotal - discountAmount;
    
    // IVA
    const tax = baseImponible * 0.15;
    
    // Total
    const total = baseImponible + tax;
    
    // Actualizar valores en el carrito
    cart.subtotal = subtotal;
    cart.discount = discountAmount;
    cart.tax = tax;
    cart.total = total;
    
    // IMPORTANTE: Buscar elementos en el tab específico
    const tabElement = document.getElementById(tabId);
    if (!tabElement) return;
    
    // Actualizar displays
    const subtotalEl = tabElement.querySelector(`#subtotal-display-${tabId}`) || 
                      tabElement.querySelector('#subtotal-display');
    const discountEl = tabElement.querySelector(`#discount-display-${tabId}`) || 
                      tabElement.querySelector('#discount-display');
    const baseEl = tabElement.querySelector(`#base-imponible-${tabId}`) || 
                  tabElement.querySelector('#base-imponible');
    const taxEl = tabElement.querySelector(`#tax-display-${tabId}`) || 
                 tabElement.querySelector('#tax-display');
    const totalEl = tabElement.querySelector(`#total-display-${tabId}`) || 
                   tabElement.querySelector('#total-display');
    const previewEl = tabElement.querySelector(`#total-preview-${tabId}`) || 
                     tabElement.querySelector('#total-preview');
    const efectivoEl = tabElement.querySelector(`#total-efectivo-preview-${tabId}`) || 
                      tabElement.querySelector('#total-efectivo-preview');
    const tarjetaEl = tabElement.querySelector(`#total-tarjeta-preview-${tabId}`) || 
                     tabElement.querySelector('#total-tarjeta-preview');
    
    if (subtotalEl) subtotalEl.textContent = `$ ${subtotal.toFixed(2)}`;
    if (discountEl) discountEl.textContent = `$ ${discountAmount.toFixed(2)}`;
    if (baseEl) baseEl.textContent = `$ ${baseImponible.toFixed(2)}`;
    if (taxEl) taxEl.textContent = `$ ${tax.toFixed(2)}`;
    if (totalEl) totalEl.textContent = `$ ${total.toFixed(2)}`;
    if (previewEl) previewEl.textContent = total.toFixed(2);
    if (efectivoEl) efectivoEl.textContent = (total * 0.95).toFixed(2);
    if (tarjetaEl) tarjetaEl.textContent = (total * 1.03).toFixed(2);
    
    // Habilitar/deshabilitar botón procesar
    const btnProcesar = tabElement.querySelector(`#btn-procesar-${tabId}`) || 
                       tabElement.querySelector('#btn-procesar');
    if (btnProcesar) {
        btnProcesar.disabled = cart.items.length === 0;
    }
    
    console.log(`💰 Totales actualizados para ${tabId}:`, { subtotal, total });
}

    function updateTabElementIds(tabElement, tabId) {
        // Lista de IDs que necesitan ser únicos por tab
        const idsToUpdate = [
            'cart-items-body',
            'cart-items-table',
            'cliente-search',
            'cliente-id',
            'client-info',
            'client-name',
            'client-document',
            'clear-client',
            'subtotal-display',
            'discount-display',
            'base-imponible',
            'tax-display',
            'total-display',
            'total-preview',
            'total-efectivo-preview',
            'total-tarjeta-preview',
            'discount-percent',
            'custom-discount',
            'monto-recibido',
            'cambio-display',
            'btn-procesar'
        ];

        idsToUpdate.forEach(oldId => {
            const element = tabElement.querySelector(`#${oldId}`);
            if (element) {
                element.id = `${oldId}-${tabId}`;
            }
        });
    }

    function switchToTab(tabId) {
        const oldTabId = currentTabId;
        currentTabId = tabId;

        // Actualizar la vista del carrito
        updateCartDisplay();
        updateTotals();
        updateClientDisplay();

        console.log('Switched to tab:', tabId);
    }

    async function closeTab(tabId) {
        const visibleTabs = document.querySelectorAll('.nav-tabs-enhanced .nav-item a[href^="#venta"]').length;

        if (visibleTabs <= 1) {
            showToast('Debe mantener al menos una venta abierta', 'warning');
            return;
        }

        if (carts[tabId] && carts[tabId].items.length > 0) {
            const confirmed = await showConfirm({
                title: '¿Cerrar Venta?',
                message: '¿Está seguro de cerrar esta venta? Se perderán los productos seleccionados.',
                type: 'warning',
                confirmText: 'Sí, cerrar',
                cancelText: 'No, mantener abierta'
            });
            
            if (!confirmed) return;
        }

        // Eliminar el tab de la navegación
        const tabElement = document.querySelector(`a[href="#${tabId}"]`).closest('.nav-item');
        tabElement.remove();

        // Eliminar el carrito
        delete carts[tabId];

        // Actualizar visibilidad de botones de cierre
        updateCloseButtonsVisibility();

        // Si era el tab activo, cambiar a otro
        if (currentTabId === tabId) {
            const remainingTabs = Object.keys(carts);
            if (remainingTabs.length > 0) {
                switchToTab(remainingTabs[0]);
            }
        }

        showToast('Venta cerrada', 'info');
    }

    function updateCloseButtonsVisibility() {
        const closeButtons = document.querySelectorAll('.btn-close-tab-enhanced');
        const visibleTabs = document.querySelectorAll('.nav-tabs-enhanced .nav-item a[href^="#venta"]').length;
        const showButtons = visibleTabs > 1;

        closeButtons.forEach(button => {
            button.style.display = showButtons ? 'flex' : 'none';
        });
    }

    function updateTabBadge() {
        const currentCart = getCurrentCart();
        const badge = document.querySelector(`#badge-${currentTabId}`);
        if (badge) {
            const totalItems = currentCart.items.reduce((sum, item) => sum + item.quantity, 0);
            badge.textContent = totalItems;
            badge.style.display = totalItems > 0 ? 'inline' : 'none';
        }
    }

    // ============================================
    // FUNCIONES DE GESTIÓN DE PRODUCTOS
    // ============================================

    function addToCartFromElement(element) {
        // Extraer datos del elemento
        const productId = parseInt(element.getAttribute('data-product-id'));
        const productName = element.getAttribute('data-product-name');
        const priceStr = element.getAttribute('data-product-price');
        const stockStr = element.getAttribute('data-product-stock');

        // Validar que existan los atributos
        if (!productId || !productName || !priceStr || !stockStr) {
            console.error('Elemento con datos incompletos:', {
                id: productId,
                name: productName,
                price: priceStr,
                stock: stockStr
            });
            showToast('Error: datos de producto incompletos', 'error');
            return;
        }

        // Parsear valores numéricos
        const price = parseFloat(priceStr);
        const stock = parseInt(stockStr);

        // Validar conversiones
        if (isNaN(price) || isNaN(stock)) {
            console.error('Error al convertir valores:', { priceStr, stockStr, price, stock });
            showToast('Error: datos de producto inválidos', 'error');
            return;
        }

        // Agregar al carrito
        addToCart(productId, productName, price, stock);
    }

    function addToCart(productId, productName, price, stock) {
        const currentCart = getCurrentCart();

        // Validar datos de entrada
        if (!productId || !productName) {
            showToast('Datos de producto inválidos', 'error');
            console.error('Producto inválido:', { productId, productName, price, stock });
            return;
        }

        // Convertir y validar valores numéricos
        const validPrice = parseFloat(price);
        const validStock = parseInt(stock);

        if (isNaN(validPrice) || validPrice < 0) {
            showToast('Precio de producto inválido', 'error');
            console.error('Precio inválido:', price);
            return;
        }

        // Permitir cualquier precio >= 0 sin confirmación

        if (isNaN(validStock) || validStock <= 0) {
            showToast('Producto sin stock disponible', 'error');
            return;
        }

        // Buscar si el producto ya existe en el carrito
        let existingItem = currentCart.items.find(item => item.id === productId);

        if (existingItem) {
            // Verificar que no exceda el stock
            if (existingItem.quantity >= validStock) {
                showToast('No hay suficiente stock disponible', 'warning');
                return;
            }
            existingItem.quantity++;
        } else {
            // Agregar nuevo producto al carrito
            currentCart.items.push({
                id: productId,
                name: productName,
                price: validPrice,
                quantity: 1,
                stock: validStock,
                discount: 0,
                taxRate: 0.15
            });
        }

        updateCartDisplay();
        updateTotals();
        showToast(`${productName} agregado al carrito`, 'success');
        
        console.log('Producto agregado:', { productId, productName, price: validPrice, stock: validStock });
    }

    function updateQuantity(index, change) {
        const currentCart = getCurrentCart();
        
        if (index < 0 || index >= currentCart.items.length) {
            console.error('Índice inválido:', index);
            return;
        }
        
        const item = currentCart.items[index];
        const newQuantity = parseInt(item.quantity) + parseInt(change);

        if (newQuantity <= 0) {
            removeFromCart(index);
        } else if (newQuantity <= item.stock) {
            item.quantity = newQuantity;
            updateCartDisplay();
            updateTotals();
        } else {
            showToast(`Stock máximo disponible: ${item.stock}`, 'warning');
        }
    }

    function setQuantity(index, quantity) {
        const currentCart = getCurrentCart();
        
        if (index < 0 || index >= currentCart.items.length) {
            console.error('Índice inválido:', index);
            return;
        }
        
        const item = currentCart.items[index];
        const qty = parseInt(quantity);

        if (isNaN(qty)) {
            showToast('Cantidad inválida', 'error');
            updateCartDisplay();
            return;
        }

        if (qty <= 0) {
            removeFromCart(index);
        } else if (qty <= item.stock) {
            item.quantity = qty;
            updateCartDisplay();
            updateTotals();
        } else {
            showToast(`Stock máximo disponible: ${item.stock}`, 'warning');
            item.quantity = item.stock;
            updateCartDisplay();
            updateTotals();
        }
    }

    function removeFromCart(index) {
        const currentCart = getCurrentCart();
        if (index >= 0 && index < currentCart.items.length) {
            const removedItem = currentCart.items[index];
            currentCart.items.splice(index, 1);
            
            // Actualizar vista y totales
            updateCartDisplay();
            updateTotalsForTab(currentTabId); // ✅ Esto resetea los totales
            
            showToast(`${removedItem.name} eliminado del carrito`, 'info');
        }
    }

async function clearCart() {
    const confirmed = await showConfirm({
        title: '¿Limpiar Carrito?',
        message: '¿Está seguro de que desea eliminar todos los productos del carrito?',
        type: 'warning',
        confirmText: 'Sí, limpiar',
        cancelText: 'No, cancelar'
    });
    
    if (!confirmed) return;

    const currentCart = getCurrentCart();
    currentCart.items = [];
    currentCart.total = 0;
    currentCart.subtotal = 0;
    currentCart.discount = 0;
    currentCart.tax = 0;

    updateCartDisplay();
    updateTotalsForTab(currentTabId); // ✅ Esto resetea los totales
    
    showToast('Carrito limpiado', 'info');
}

    // ============================================
    // FUNCIONES DE VISUALIZACIÓN
    // ============================================

    function updateCartDisplay() {
    const currentCart = getCurrentCart();
    
    // Buscar tbody en el tab actual
    const tabElement = document.getElementById(currentTabId);
    if (!tabElement) {
        console.error('No se encontró el tab:', currentTabId);
        return;
    }
    
    const tbody = tabElement.querySelector(`#cart-items-body-${currentTabId}`) || 
                  tabElement.querySelector('#cart-items-body');

    if (!tbody) {
        console.error(`No se encontró tbody para el tab: ${currentTabId}`);
        return;
    }

    if (currentCart.items.length === 0) {
        tbody.innerHTML = `
        <tr>
            <td colspan="12" class="text-center text-muted py-4">
                <i class="fas fa-shopping-cart fa-3x mb-3"></i>
                <p>Carrito vacío</p>
                <small>Seleccione productos para agregar</small>
            </td>
        </tr>
    `;
        updateTabBadge();
        return;
    }

    let cartHTML = '';
    currentCart.items.forEach((item, index) => {
        const precio = parseFloat(item.price);
        const cantidad = parseInt(item.quantity);
        const tasaImpuesto = parseFloat(item.taxRate || 0.15);
        
        const subtotalItem = precio * cantidad;
        const descuentoItem = subtotalItem * (parseFloat(currentDiscount) / 100);
        const despuesDescuento = subtotalItem - descuentoItem;
        const ivaItem = despuesDescuento * tasaImpuesto;
        const totalItem = despuesDescuento + ivaItem;

        cartHTML += `
        <tr>
            <td>${index + 1}</td>
            <td>${item.id}</td>
            <td>
                <div class="product-name">${item.name}</div>
                <div class="product-code">Stock: ${item.stock}</div>
            </td>
            <td>
                <input type="number" value="${cantidad}" 
                       data-index="${index}"
                       class="quantity-input"
                       min="1" max="${item.stock}"
                       style="width: 60px;">
            </td>
            <td>$ ${precio.toFixed(2)}</td>
            <td>$ ${precio.toFixed(2)}</td>
            <td>0%</td>
            <td>${currentDiscount}%</td>
            <td>$ ${ivaItem.toFixed(2)}</td>
            <td>$ ${subtotalItem.toFixed(2)}</td>
            <td><strong>$ ${totalItem.toFixed(2)}</strong></td>
            <td>
                <button class="btn-action btn-edit" data-index="${index}" data-action="edit" title="Editar">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn-action btn-delete" data-index="${index}" data-action="delete" title="Eliminar">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        </tr>
    `;
    });

    tbody.innerHTML = cartHTML;
    updateTabBadge();
    
    // Re-vincular event listeners
    const quantityInputs = tbody.querySelectorAll('.quantity-input');
    quantityInputs.forEach(input => {
        input.addEventListener('change', function() {
            const index = parseInt(this.getAttribute('data-index'));
            setQuantity(index, this.value);
        });
    });
    
    const actionButtons = tbody.querySelectorAll('[data-action]');
    actionButtons.forEach(button => {
        button.addEventListener('click', function() {
            const index = parseInt(this.getAttribute('data-index'));
            const action = this.getAttribute('data-action');
            
            if (action === 'edit') {
                editCartItem(index);
            } else if (action === 'delete') {
                removeFromCart(index);
            }
        });
    });
    
    console.log(`🛒 Carrito actualizado para ${currentTabId}: ${currentCart.items.length} items`);
}

    function updateTotals() {
        const currentCart = getCurrentCart();

        // Calcular subtotal (suma de precio * cantidad de cada item)
        const subtotal = currentCart.items.reduce((sum, item) => {
            return sum + (parseFloat(item.price) * parseInt(item.quantity));
        }, 0);

        // Calcular descuento sobre el subtotal
        const discountAmount = subtotal * (parseFloat(currentDiscount) / 100);

        // Base imponible (después del descuento)
        const baseImponible = subtotal - discountAmount;

        // Calcular IVA sobre la base imponible
        const tax = baseImponible * 0.15;

        // Total final (base imponible + IVA)
        const total = baseImponible + tax;

        // Actualizar valores en el carrito
        currentCart.subtotal = subtotal;
        currentCart.discount = discountAmount;
        currentCart.tax = tax;
        currentCart.total = total;

        // Actualizar displays con validación de elementos
        const subtotalEl = document.getElementById('subtotal-display');
        const discountEl = document.getElementById('discount-display');
        const baseEl = document.getElementById('base-imponible');
        const taxEl = document.getElementById('tax-display');
        const totalEl = document.getElementById('total-display');
        const previewEl = document.getElementById('total-preview');
        const efectivoEl = document.getElementById('total-efectivo-preview');
        const tarjetaEl = document.getElementById('total-tarjeta-preview');
        
        if (subtotalEl) subtotalEl.textContent = `$ ${subtotal.toFixed(2)}`;
        if (discountEl) discountEl.textContent = `$ ${discountAmount.toFixed(2)}`;
        if (baseEl) baseEl.textContent = `$ ${baseImponible.toFixed(2)}`;
        if (taxEl) taxEl.textContent = `$ ${tax.toFixed(2)}`;
        if (totalEl) totalEl.textContent = `$ ${total.toFixed(2)}`;
        
        // Actualizar previews de precio
        if (previewEl) previewEl.textContent = total.toFixed(2);
        if (efectivoEl) efectivoEl.textContent = (total * 0.95).toFixed(2); // 5% desc
        if (tarjetaEl) tarjetaEl.textContent = (total * 1.03).toFixed(2); // 3% recargo

        // Habilitar/deshabilitar botón procesar
        const btnProcesar = document.getElementById('btn-procesar');
        if (btnProcesar) {
            btnProcesar.disabled = currentCart.items.length === 0;
        }

        // Recalcular cambio
        calculateChange();
        
        console.log('Totales actualizados:', { subtotal, discountAmount, baseImponible, tax, total });
    }

    function calculateChange() {
        const currentCart = getCurrentCart();
        const montoRecibidoEl = document.getElementById('monto-recibido');
        const cambioEl = document.getElementById('cambio-display');

        if (!montoRecibidoEl || !cambioEl) return;

        const montoRecibido = parseFloat(montoRecibidoEl.value) || 0;
        const cambio = montoRecibido - currentCart.total;

        cambioEl.textContent = `$ ${cambio.toFixed(2)}`;

        if (cambio < 0) {
            cambioEl.style.color = 'var(--danger-red)';
        } else {
            cambioEl.style.color = 'var(--success-green)';
        }
    }

    // ============================================
    // FUNCIONES DE DESCUENTO Y PAGO
    // ============================================

    function applyDiscount(percent) {
        currentDiscount = parseFloat(percent) || 0;

        // Actualizar botones de descuento
        document.querySelectorAll('.discount-btn').forEach(btn => {
            btn.classList.remove('active');
            if (parseFloat(btn.dataset.discount) === currentDiscount) {
                btn.classList.add('active');
            }
        });

        // Actualizar display de porcentaje
        document.getElementById('discount-percent').textContent = currentDiscount;

        // Recalcular totales
        updateCartDisplay();
        updateTotals();

        showToast(`Descuento de ${currentDiscount}% aplicado`, 'success');
    }

    function selectPaymentMethod(method) {
        selectedPaymentMethod = method;

        // Actualizar botones de método de pago
        document.querySelectorAll('.payment-method').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.method === method) {
                btn.classList.add('active');
            }
        });

        // Actualizar precio según método
        const currentCart = getCurrentCart();
        const montoRecibidoEl = document.getElementById('monto-recibido');

        if (method === 'efectivo') {
            // Sugerir total con descuento de efectivo
            if (montoRecibidoEl) {
                montoRecibidoEl.value = (currentCart.total * 0.95).toFixed(2);
            }
        } else if (method === 'tarjeta') {
            // Sugerir total con recargo de tarjeta
            if (montoRecibidoEl) {
                montoRecibidoEl.value = (currentCart.total * 1.03).toFixed(2);
            }
        } else {
            // Transferencia - monto exacto
            if (montoRecibidoEl) {
                montoRecibidoEl.value = currentCart.total.toFixed(2);
            }
        }

        calculateChange();
    }

    // ============================================
    // FUNCIONES DE CLIENTE
    // ============================================

    function setupClientSearch() {
        const clienteSearch = document.getElementById('cliente-search');
        if (!clienteSearch) return;

        let searchTimeout;
        clienteSearch.addEventListener('input', function () {
            clearTimeout(searchTimeout);
            const query = this.value.trim();

            if (query.length >= 3) {
                searchTimeout = setTimeout(() => {
                    searchClient(query);
                }, 300);
            } else {
                clearClientInfo();
            }
        });

        clienteSearch.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const query = this.value.trim();
                if (query.length > 0) {
                    searchClient
                        (query);
                }
            }
        });
    }

    function searchClient(query) {
    fetch(`/clientes/buscar/?search=${encodeURIComponent(query)}`, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Error en la respuesta del servidor');
        }
        return response.json();
    })
    .then(data => {
        console.log('Respuesta del servidor:', data);
        
        // Intentar diferentes formatos de respuesta
        let clientes = [];
        if (Array.isArray(data)) {
            clientes = data;
        } else if (data.clientes && Array.isArray(data.clientes)) {
            clientes = data.clientes;
        } else if (data.results && Array.isArray(data.results)) {
            clientes = data.results;
        }
        
        if (clientes.length > 0) {
            const cliente = clientes[0];
            displayClientInfo(cliente);
        } else {
            clearClientInfo();
            showClientNotFound(query);
        }
    })
    .catch(error => {
        console.error('Error al buscar cliente:', error);
        clearClientInfo();
        showToast('Error al buscar cliente: ' + error.message, 'error');
    });
}

function displayClientInfo(cliente) {
    const clientInfo = document.getElementById('client-info');
    const clienteId = document.getElementById('cliente-id');
    const clientNameEl = document.getElementById('client-name');
    const clientDocEl = document.getElementById('client-document');
    
    if (clientInfo && clienteId && clientNameEl && clientDocEl) {
        const currentCart = getCurrentCart();
        
        // Extraer el ID del cliente
        currentCart.cliente_id = cliente.id || cliente.pk || null;
        
        // Extraer nombre (probar diferentes campos)
        currentCart.cliente_nombre = cliente.nombre || cliente.razon_social || cliente.name || 'Cliente sin nombre';
        
        // Extraer documento (probar diferentes campos)
        currentCart.cliente_documento = cliente.cedula || cliente.ruc || cliente.documento || cliente.identificacion || 'Sin documento';
        
        clientNameEl.textContent = currentCart.cliente_nombre;
        clientDocEl.textContent = currentCart.cliente_documento;
        clienteId.value = currentCart.cliente_id;
        
        clientInfo.classList.add('active');
        
        showToast(`Cliente ${currentCart.cliente_nombre} seleccionado`, 'success');
    }
}

function clearClientInfo() {
    const clientInfo = document.getElementById('client-info');
    const clienteId = document.getElementById('cliente-id');
    
    if (clientInfo) {
        clientInfo.classList.remove('active');
    }
    
    if (clienteId) {
        clienteId.value = '';
    }
    
    const currentCart = getCurrentCart();
    currentCart.cliente_id = null;
    currentCart.cliente_nombre = null;
    currentCart.cliente_documento = null;
}

function showClientNotFound(query) {
    showToast(`No se encontró cliente con: "${query}"`, 'warning');
}

function updateClientDisplay() {
    const currentCart = getCurrentCart();
    
    if (currentCart.cliente_id && currentCart.cliente_nombre) {
        displayClientInfo({
            id: currentCart.cliente_id,
            nombre: currentCart.cliente_nombre,
            documento: currentCart.cliente_documento
        });
    } else {
        clearClientInfo();
    }
}

// ============================================
// PROCESAR VENTA
// ============================================

async function procesarVenta() {
    const currentCart = getCurrentCart();
    
    if (currentCart.items.length === 0) {
        showToast('El carrito está vacío', 'error');
        return;
    }
    
    const montoRecibidoEl = document.getElementById('monto-recibido');
    const montoRecibido = montoRecibidoEl ? parseFloat(montoRecibidoEl.value) || 0 : 0;
    
    if (selectedPaymentMethod === 'efectivo' && montoRecibido < currentCart.total) {
        showToast('El monto recibido es insuficiente', 'error');
        return;
    }
    
    const confirmed = await showConfirm({
        title: 'Procesar Venta',
        message: `¿Desea procesar esta venta por un total de $${currentCart.total.toFixed(2)}?`,
        type: 'success',
        confirmText: 'Sí, procesar',
        cancelText: 'Cancelar'
    });
    
    if (!confirmed) return;
    
    // Mostrar loading
    showLoading();
    
    // Preparar datos de la venta
    const ventaData = {
        cliente_id: currentCart.cliente_id || null,
        items: currentCart.items.map(item => ({
            producto_id: item.id,
            cantidad: parseInt(item.quantity),
            precio_unitario: parseFloat(item.price),
            descuento: parseFloat(currentDiscount)
        })),
        pagos: [{
            forma_pago: selectedPaymentMethod,
            monto: parseFloat(currentCart.total)
        }],
        descuento_global: parseFloat(currentDiscount),
        subtotal: parseFloat(currentCart.subtotal),
        iva: parseFloat(currentCart.tax),
        total: parseFloat(currentCart.total)
    };
    
    console.log('Datos de venta a enviar:', ventaData);
    
    // Obtener el token CSRF
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    // Enviar venta al servidor
    fetch('/ventas/crear-ajax/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify(ventaData)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`Error HTTP: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        hideLoading();
        
        console.log('Respuesta del servidor:', data);
        
        if (data.success) {
            // Almacenar información de la venta
            ultimaVenta = {
                numero_venta: data.numero_venta || 'N/A',
                total: data.total || currentCart.total,
                venta_id: data.venta_id || data.id,
                json_facturacion: data.json_facturacion
            };
            
            const numeroVentaEl = document.getElementById('numero-venta');
            const totalVentaEl = document.getElementById('total-venta');
            
            if (numeroVentaEl) numeroVentaEl.textContent = ultimaVenta.numero_venta;
            if (totalVentaEl) totalVentaEl.textContent = `$ ${currentCart.total.toFixed(2)}`;
            
            // Mostrar información del JSON si está disponible
            const jsonInfoEl = document.getElementById('json-info');
            if (data.json_facturacion && jsonInfoEl) {
                jsonInfoEl.style.display = 'block';
            }
            
            // Limpiar el carrito después de procesar
            currentCart.items = [];
            currentCart.total = 0;
            currentCart.subtotal = 0;
            currentCart.discount = 0;
            currentCart.tax = 0;
            currentCart.cliente_id = null;
            currentCart.cliente_nombre = null;
            currentCart.cliente_documento = null;
            
            updateCartDisplay();
            updateTotals();
            clearClientInfo();
            
            // Resetear form de pago
            if (montoRecibidoEl) montoRecibidoEl.value = '';
            currentDiscount = 0;
            applyDiscount(0);
            
            // Mostrar modal
            const modalEl = document.getElementById('ventaModal');
            if (modalEl) {
                const modal = new bootstrap.Modal(modalEl);
                modal.show();
            }
            
            showToast('Venta procesada exitosamente', 'success');
        } else {
            showToast('Error al procesar la venta: ' + (data.error || data.message || 'Error desconocido'), 'error');
        }
    })
    .catch(error => {
        hideLoading();
        console.error('Error al procesar venta:', error);
        showToast('Error al procesar la venta: ' + error.message, 'error');
    });
}

function nuevaVenta() {
    const montoRecibido = document.getElementById('monto-recibido');
    if (montoRecibido) {
        montoRecibido.value = '';
    }
    selectedPaymentMethod = 'efectivo';
    selectPaymentMethod('efectivo');
    currentDiscount = 0;
    applyDiscount(0);
}

async function cancelSale() {
    const confirmed = await showConfirm({
        title: '¿Cancelar Venta?',
        message: '¿Está seguro de cancelar la venta actual? Se perderán todos los datos.',
        type: 'danger',
        confirmText: 'Sí, cancelar venta',
        cancelTextLabel: 'No, continuar'
    });
    
    if (!confirmed) return;
    
    // Limpiar sin confirmación adicional
    const currentCart = getCurrentCart();
    currentCart.items = [];
    currentCart.total = 0;
    currentCart.subtotal = 0;
    currentCart.discount = 0;
    currentCart.tax = 0;

    updateCartDisplay();
    updateTotals();
    clearClientInfo();
    
    const montoRecibido = document.getElementById('monto-recibido');
    if (montoRecibido) {
        montoRecibido.value = '';
    }
    showToast('Venta cancelada', 'info');
}

// ============================================
// FUNCIONES DE IMPRESIÓN
// ============================================

function imprimirTicket() {
    if (ultimaVenta.numero_venta) {
        const url = `/ventas/ticket/${ultimaVenta.numero_venta}/`;
        window.open(url, '_blank');
    } else {
        showToast('No hay información de venta disponible', 'error');
    }
}

function imprimirTicketTermico() {
    if (ultimaVenta.venta_id) {
        const url = `/ventas/${ultimaVenta.venta_id}/ticket-termico/`;
        window.open(url, '_blank', 'width=400,height=600');
    } else {
        showToast('No hay información de venta disponible', 'error');
    }
}

function descargarJSON() {
    if (ultimaVenta.venta_id) {
        const url = `/ventas/${ultimaVenta.venta_id}/json-facturacion/`;
        window.open(url, '_blank');
    } else {
        showToast('No hay información de venta disponible', 'error');
    }
}

// ============================================
// FUNCIONES DE UI Y UTILIDADES
// ============================================

// Función de confirmación personalizada
let confirmCallback = null;

function showConfirm(options) {
    return new Promise((resolve) => {
        const {
            title = 'Confirmación',
            message = '¿Está seguro?',
            type = 'question', // question, warning, danger, info, success
            confirmText = 'Aceptar',
            cancelTextLabel = 'Cancelar',
            confirmButtonClass = 'btn-primary'
        } = options;
        
        // Configurar icono y colores según el tipo
        const iconConfig = {
            question: { icon: 'fa-question-circle', color: '#0066cc', bg: '#e6f2ff' },
            warning: { icon: 'fa-exclamation-triangle', color: '#ffc107', bg: '#fff3cd' },
            danger: { icon: 'fa-exclamation-circle', color: '#dc3545', bg: '#f8d7da' },
            info: { icon: 'fa-info-circle', color: '#17a2b8', bg: '#d1ecf1' },
            success: { icon: 'fa-check-circle', color: '#28a745', bg: '#d4edda' }
        };
        
        const config = iconConfig[type] || iconConfig.question;
        
        // Actualizar el modal
        const modal = document.getElementById('confirmModal');
        const header = document.getElementById('confirm-header');
        const iconContainer = document.getElementById('confirm-icon-container');
        const icon = document.getElementById('confirm-icon');
        const titleEl = document.getElementById('confirm-title');
        const messageEl = document.getElementById('confirm-message');
        const okBtn = document.getElementById('confirm-ok-btn');
        const cancelBtn = document.getElementById('confirm-cancel-btn');
        const okText = document.getElementById('confirm-ok-text');
        const cancelText = document.getElementById('confirm-cancel-text');
        
        // Aplicar estilos
        header.style.background = 'white';
        iconContainer.style.background = config.bg;
        icon.className = `fas ${config.icon}`;
        icon.style.color = config.color;
        titleEl.textContent = title;
        messageEl.textContent = message;
        okText.textContent = confirmText;
        cancelText.textContent = cancelTextLabel;
        
        // Configurar botón de confirmación
        okBtn.className = `btn ${confirmButtonClass}`;
        okBtn.style.padding = '10px 30px';
        okBtn.style.borderRadius = '8px';
        
        if (type === 'danger') {
            okBtn.style.background = 'linear-gradient(135deg, #dc3545 0%, #c82333 100%)';
            okBtn.style.border = 'none';
        } else if (type === 'warning') {
            okBtn.style.background = 'linear-gradient(135deg, #ffc107 0%, #e0a800 100%)';
            okBtn.style.border = 'none';
            okBtn.style.color = '#212529';
        } else {
            okBtn.style.background = 'linear-gradient(135deg, #0066cc 0%, #003d7a 100%)';
            okBtn.style.border = 'none';
        }
        
        // Configurar callbacks
        const handleConfirm = () => {
            bsModal.hide();
            resolve(true);
        };
        
        const handleCancel = () => {
            bsModal.hide();
            resolve(false);
        };
        
        // Remover listeners anteriores
        okBtn.replaceWith(okBtn.cloneNode(true));
        cancelBtn.replaceWith(cancelBtn.cloneNode(true));
        
        // Obtener los nuevos botones
        const newOkBtn = document.getElementById('confirm-ok-btn');
        const newCancelBtn = document.getElementById('confirm-cancel-btn');
        
        // Reaplicar estilos al botón clonado
        newOkBtn.className = okBtn.className;
        newOkBtn.style.cssText = okBtn.style.cssText;
        document.getElementById('confirm-ok-text').textContent = confirmText;
        document.getElementById('confirm-cancel-text').textContent = cancelTextLabel;
        
        // Agregar nuevos listeners
        newOkBtn.addEventListener('click', handleConfirm);
        newCancelBtn.addEventListener('click', handleCancel);
        
        // Mostrar modal
        const bsModal = new bootstrap.Modal(modal);
        bsModal.show();
        
        // Manejar cierre del modal
        modal.addEventListener('hidden.bs.modal', () => {
            resolve(false);
        }, { once: true });
    });
}

function showToast(message, type = 'info', duration = 3000) {
    const toast = document.createElement('div');
    toast.className = `toast-notification toast-${type}`;
    
    const iconMap = {
        'success': 'check-circle',
        'error': 'exclamation-circle',
        'warning': 'exclamation-triangle',
        'info': 'info-circle'
    };
    
    const colorMap = {
        'success': '#28a745',
        'error': '#dc3545',
        'warning': '#ffc107',
        'info': '#0066cc'
    };
    
    const bgColorMap = {
        'success': '#d4edda',
        'error': '#f8d7da',
        'warning': '#fff3cd',
        'info': '#d1ecf1'
    };
    
    toast.style.cssText = `
        position: fixed;
        top: 80px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
        max-width: 400px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        padding: 16px 20px;
        border-left: 4px solid ${colorMap[type]};
        animation: slideInRight 0.3s ease-out;
        margin-bottom: 10px;
    `;
    
    toast.innerHTML = `
        <div style="display: flex; align-items: start; gap: 12px;">
            <div style="
                width: 40px;
                height: 40px;
                border-radius: 50%;
                background: ${bgColorMap[type]};
                display: flex;
                align-items: center;
                justify-content: center;
                flex-shrink: 0;
            ">
                <i class="fas fa-${iconMap[type]}" style="color: ${colorMap[type]}; font-size: 1.2rem;"></i>
            </div>
            <div style="flex: 1; padding-top: 4px;">
                <div style="font-weight: 600; color: #212529; margin-bottom: 4px;">
                    ${type === 'success' ? '¡Éxito!' : type === 'error' ? 'Error' : type === 'warning' ? 'Advertencia' : 'Información'}
                </div>
                <div style="font-size: 0.9rem; color: #6c757d;">
                    ${message}
                </div>
            </div>
            <button type="button" onclick="this.closest('.toast-notification').remove()" style="
                background: none;
                border: none;
                color: #6c757d;
                cursor: pointer;
                font-size: 1.2rem;
                padding: 0;
                width: 24px;
                height: 24px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 4px;
                transition: all 0.2s;
            " onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='none'">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    
    document.body.appendChild(toast);
    
    // Animación de salida
    setTimeout(() => {
        if (toast.parentNode) {
            toast.style.animation = 'slideOutRight 0.3s ease-out';
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 300);
        }
    }, duration);
}

function showLoading() {
    const loading = document.createElement('div');
    loading.className = 'loading-overlay';
    loading.id = 'loading-overlay';
    loading.innerHTML = '<div class="loading-spinner"></div>';
    document.body.appendChild(loading);
}

function hideLoading() {
    const loading = document.getElementById('loading-overlay');
    if (loading) {
        loading.remove();
    }
}

function updateCurrentDate() {
    const now = new Date();
    const options = { 
        year: 'numeric', 
        month: '2-digit', 
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
    };
    const dateElement = document.getElementById('current-date');
    if (dateElement) {
        dateElement.textContent = now.toLocaleString('es-EC', options);
    }
}

// Funciones de acciones rápidas (placeholders)
function showShiftChange() { 
    showToast('Función de cambio de turno en desarrollo', 'info'); 
}

function showInvoices() { 
    window.location.href = '/ventas/';
}

function showPayments() { 
    showToast('Función de pagos en desarrollo', 'info'); 
}

function showDiscounts() { 
    const customDiscountInput = document.getElementById('custom-discount');
    if (customDiscountInput) {
        customDiscountInput.focus();
    }
}

function showKardex() { 
    showToast('Función de kardex en desarrollo', 'info'); 
}

function showRecharges() { 
    showToast('Función de recargas en desarrollo', 'info'); 
}

function showDocuments() { 
    showToast('Función de documentos en desarrollo', 'info'); 
}

function focusProductSearch() {
    const searchInput = document.getElementById('search-products');
    if (searchInput) {
        searchInput.focus();
        searchInput.select();
    }
}

function editCartItem(index) {
    const currentCart = getCurrentCart();
    const item = currentCart.items[index];
    
    if (!item) {
        showToast('Producto no encontrado en el carrito', 'error');
        return;
    }
    
    // Guardar el índice para usarlo al guardar
    window.currentEditIndex = index;
    
    // Actualizar los datos del modal
    document.getElementById('edit-product-name').textContent = item.name;
    document.getElementById('edit-product-stock').textContent = item.stock;
    document.getElementById('edit-quantity-input').value = item.quantity;
    document.getElementById('edit-quantity-input').max = item.stock;
    
    // Mostrar el modal
    const modal = new bootstrap.Modal(document.getElementById('editQuantityModal'));
    modal.show();
    
    // Enfocar el input después de que se muestre el modal
    setTimeout(() => {
        const input = document.getElementById('edit-quantity-input');
        if (input) {
            input.focus();
            input.select();
        }
    }, 300);
}

// Función para ajustar cantidad con botones + y -
function adjustEditQuantity(change) {
    const input = document.getElementById('edit-quantity-input');
    if (!input) return;
    
    const currentValue = parseInt(input.value) || 1;
    const maxValue = parseInt(input.max) || 9999;
    const newValue = Math.max(1, Math.min(maxValue, currentValue + change));
    
    input.value = newValue;
}

// Función para guardar la cantidad editada
function saveEditQuantity() {
    const input = document.getElementById('edit-quantity-input');
    const newQuantity = parseInt(input.value);
    
    if (isNaN(newQuantity) || newQuantity < 1) {
        showToast('Por favor ingrese una cantidad válida', 'warning');
        return;
    }
    
    const index = window.currentEditIndex;
    if (index === undefined || index === null) {
        showToast('Error al actualizar la cantidad', 'error');
        return;
    }
    
    // Actualizar la cantidad
    setQuantity(index, newQuantity);
    
    // Cerrar el modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('editQuantityModal'));
    if (modal) {
        modal.hide();
    }
    
    showToast('Cantidad actualizada correctamente', 'success');
}

// Permitir usar Enter para guardar
document.addEventListener('DOMContentLoaded', function() {
    // Convertir todos los precios de punto a coma
    document.querySelectorAll('.price-value').forEach(el => {
        el.textContent = el.textContent.replace('.', ',');
    });
    
    const editInput = document.getElementById('edit-quantity-input');
    if (editInput) {
        editInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                saveEditQuantity();
            }
        });
        
        // Permitir usar flechas para ajustar
        editInput.addEventListener('keydown', function(e) {
            if (e.key === 'ArrowUp') {
                e.preventDefault();
                adjustEditQuantity(1);
            } else if (e.key === 'ArrowDown') {
                e.preventDefault();
                adjustEditQuantity(-1);
            }
        });
    }
});

// ============================================
// BÚSQUEDA Y FILTRADO DE PRODUCTOS
// ============================================

function setupProductSearch() {
    const searchInput = document.getElementById('search-products');
    const categoryFilter = document.getElementById('filter-category');
    const brandFilter = document.getElementById('filter-brand');
    
    if (searchInput) {
        let searchTimeout;
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                filterProducts();
            }, 200);
        });
        
        searchInput.addEventListener('keyup', function(e) {
            if (e.key === 'Enter') {
                filterProducts();
            }
        });
        
        console.log('✓ Input de búsqueda configurado');
    } else {
        console.warn('⚠ No se encontró el input de búsqueda');
    }
    
    if (categoryFilter) {
        categoryFilter.addEventListener('change', function() {
            console.log('Categoría seleccionada:', this.value);
            filterProducts();
        });
    }
    
    if (brandFilter) {
        brandFilter.addEventListener('change', filterProducts);
    }
}

function filterProducts() {
    const searchInput = document.getElementById('search-products');
    const categorySelect = document.getElementById('filter-category');
    const loadingIndicator = document.getElementById('search-loading');
    
    const searchTerm = searchInput ? searchInput.value.trim() : '';
    const categoryFilter = categorySelect ? categorySelect.value : '';
    
    console.log('Búsqueda iniciada:', searchTerm);
    
    // Si no hay término de búsqueda, recargar productos iniciales
    if (searchTerm.length === 0) {
        console.log('Campo vacío, recargando productos iniciales');
        if (loadingIndicator) loadingIndicator.style.display = 'none';
        
        // Recargar la página actual desde allProductos
        if (allProductos && allProductos.length > 0) {
            showPage(currentPage);
        } else {
            // Si no hay productos en memoria, mostrar los del DOM
            const productCards = document.querySelectorAll('.product-card-enhanced');
            productCards.forEach(card => {
                const categoryId = card.getAttribute('data-category-id');
                const matchesCategory = !categoryFilter || categoryId === categoryFilter;
                card.style.display = matchesCategory ? 'block' : 'none';
            });
        }
        return;
    }
    
    // Búsqueda local primero (más rápida)
    if (searchTerm.length < 3) {
        console.log('Búsqueda local para término corto');
        const searchLower = searchTerm.toLowerCase();
        const productCards = document.querySelectorAll('.product-card-enhanced');
        let visibleCount = 0;
        
        productCards.forEach(card => {
            const nameEl = card.querySelector('.name');
            const codeEl = card.querySelector('.code');
            const priceEl = card.querySelector('.price');
            const categoryId = card.getAttribute('data-category-id');
            
            if (!nameEl || !codeEl) return;
            
            const name = nameEl.textContent.toLowerCase();
            const code = codeEl.textContent.toLowerCase();
            const price = priceEl ? priceEl.textContent.toLowerCase() : '';
            
            const matchesSearch = name.includes(searchLower) || 
                                code.includes(searchLower) || 
                                price.includes(searchLower);
            const matchesCategory = !categoryFilter || categoryId === categoryFilter;
            
            if (matchesSearch && matchesCategory) {
                card.style.display = 'block';
                visibleCount++;
            } else {
                card.style.display = 'none';
            }
        });
        
        console.log(`Búsqueda local: ${visibleCount} productos encontrados`);
        return;
    }
    
    // Búsqueda AJAX para términos más largos
    console.log('Realizando búsqueda AJAX para:', searchTerm);
    
    if (loadingIndicator) loadingIndicator.style.display = 'block';
    
    const searchUrl = '/ventas/buscar-producto/';
    fetch(`${searchUrl}?search=${encodeURIComponent(searchTerm)}`, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || '',
        }
    })
    .then(response => {
        console.log('Respuesta recibida:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Datos recibidos:', data);
        if (loadingIndicator) loadingIndicator.style.display = 'none';
        
        if (data.productos) {
            updateProductsGrid(data.productos, categoryFilter);
        } else {
            console.error('No se encontró el campo productos en la respuesta');
            // Fallback a búsqueda local
            performLocalSearch(searchTerm, categoryFilter);
        }
    })
    .catch(error => {
        console.error('Error en búsqueda AJAX:', error);
        if (loadingIndicator) loadingIndicator.style.display = 'none';
        
        // Fallback a búsqueda local
        performLocalSearch(searchTerm, categoryFilter);
    });
}

// Función auxiliar para búsqueda local
function performLocalSearch(searchTerm, categoryFilter) {
    console.log('Realizando búsqueda local de respaldo');
    const searchLower = searchTerm.toLowerCase();
    const productCards = document.querySelectorAll('.product-card-enhanced');
    let visibleCount = 0;
    
    productCards.forEach(card => {
        const nameEl = card.querySelector('.name');
        const codeEl = card.querySelector('.code');
        const categoryId = card.getAttribute('data-category-id');
        
        if (!nameEl || !codeEl) return;
        
        const name = nameEl.textContent.toLowerCase();
        const code = codeEl.textContent.toLowerCase();
        
        const matchesSearch = name.includes(searchLower) || code.includes(searchLower);
        const matchesCategory = !categoryFilter || categoryId === categoryFilter;
        
        if (matchesSearch && matchesCategory) {
            card.style.display = 'block';
            visibleCount++;
        } else {
            card.style.display = 'none';
        }
    });
    
    console.log(`Búsqueda local: ${visibleCount} productos encontrados`);
}

// Función para actualizar el grid de productos con datos del servidor
function updateProductsGrid(productos, categoryFilter) {
    const productsGrid = document.getElementById('products-grid');
    if (!productsGrid) return;
    
    if (!productos || productos.length === 0) {
        productsGrid.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #6c757d;">
                <i class="fas fa-search fa-3x mb-3"></i>
                <p>No se encontraron productos</p>
                <small>Intente con otros términos de búsqueda</small>
            </div>
        `;
        return;
    }
    
    let html = '';
    productos.forEach(producto => {
        // Filtrar por categoría si está seleccionada
        const categoriaId = producto.id_categoria?.id || producto.categoria_id || '';
        if (categoryFilter && categoriaId != categoryFilter) {
            return;
        }
        
        const stock = producto.stock || 0;
        const stockClass = stock > 10 ? 'stock-high' : (stock > 0 ? 'stock-low' : 'stock-none');
        // Soportar tanto precio_venta (de cache) como precio (de AJAX)
        const precioNumerico = parseFloat(producto.precio_venta || producto.precio || 0).toFixed(2);
        const precioFormateado = precioNumerico.replace('.', ',');
        const codigo = producto.codigo_principal || producto.codigo || 'N/A';
        const nombre = producto.nombre || 'Sin nombre';
        
        // Información de ubicación
        const tieneUbicacion = producto.tiene_ubicacion || false;
        const ubicacion = producto.ubicacion || 'Sin ubicar';
        const ubicacionHtml = tieneUbicacion 
            ? `<div class="ubicacion" style="font-size: 0.75rem; color: #17a2b8; margin: 2px 0;">
                   <i class="fas fa-map-marker-alt"></i> ${ubicacion}
               </div>`
            : `<div class="ubicacion" style="font-size: 0.75rem; color: #6c757d; margin: 2px 0;">
                   <i class="fas fa-question-circle"></i> Sin ubicar
               </div>`;
        
        html += `
            <div class="product-card-enhanced" 
                 data-product-id="${producto.id}"
                 data-product-name="${nombre}"
                 data-product-price="${precioNumerico}"
                 data-product-stock="${stock}"
                 data-category-id="${categoriaId}"
                 data-name="${nombre.toLowerCase()}"
                 data-code="${codigo}"
                 onclick="addToCartFromElement(this)">
                <div class="name">${nombre}</div>
                <div class="code">Cód: ${codigo}</div>
                ${ubicacionHtml}
                <div class="price">$ ${precioFormateado}</div>
                <span class="stock ${stockClass}">
                    Stock: ${stock}
                </span>
            </div>
        `;
    });
    
    productsGrid.innerHTML = html;
    console.log(`Grid actualizado con ${productos.length} productos`);
}

// ============================================
// ATAJOS DE TECLADO
// ============================================

document.addEventListener('keydown', function(e) {
    // Prevenir acciones si se está escribiendo en un input
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
        // Permitir F11 incluso en inputs
        if (e.key !== 'F11') {
            return;
        }
    }
    
    // F2 - Cerrar Caja
    if (e.key === 'F2') {
        e.preventDefault();
        window.location.href = '{% url "caja:cerrar" %}';
    }
    // F3 - Facturas
    else if (e.key === 'F3') {
        e.preventDefault();
        showInvoices();
    }
    // F4 - Pagos
    else if (e.key === 'F4') {
        e.preventDefault();
        showPayments();
    }
    // F5 - Descuentos
    else if (e.key === 'F5') {
        e.preventDefault();
        showDiscounts();
    }
    // F6 - Kardex
    else if (e.key === 'F6') {
        e.preventDefault();
        showKardex();
    }
    // F7 - Buscar productos
    else if (e.key === 'F7') {
        e.preventDefault();
        focusProductSearch();
    }
    // F8 - Recargas
    else if (e.key === 'F8') {
        e.preventDefault();
        showRecharges();
    }
    // F9 - Documentos
    else if (e.key === 'F9') {
        e.preventDefault();
        showDocuments();
    }
    // F11 - Procesar venta
    else if (e.key === 'F11') {
        e.preventDefault();
        const btnProcesar = document.getElementById('btn-procesar');
        if (btnProcesar && !btnProcesar.disabled) {
            procesarVenta();
        }
    }
    // Ctrl+N - Nueva venta
    else if (e.ctrlKey && e.key === 'n') {
        e.preventDefault();
        createNewTab();
    }
    // ESC - Cancelar
    else if (e.key === 'Escape') {
        const activeModal = document.querySelector('.modal.show');
        if (!activeModal) {
            e.preventDefault();
            cancelSale();
        }
    }
});

// ============================================
// INICIALIZACIÓN
// ============================================

document.addEventListener('DOMContentLoaded', function() {
    console.log('===========================================');
    console.log('Inicializando POS Mejorado...');
    console.log('===========================================');
    
    // Actualizar fecha actual
    updateCurrentDate();
    setInterval(updateCurrentDate, 60000); // Actualizar cada minuto
    
    // Configurar búsqueda de clientes
    setupClientSearch();
    console.log('✓ Búsqueda de clientes configurada');
    
    // Configurar búsqueda de productos
    setupProductSearch();
    console.log('✓ Búsqueda de productos configurada');
    
    // Configurar botón limpiar cliente
    const clearClientBtn = document.getElementById('clear-client');
    if (clearClientBtn) {
        clearClientBtn.addEventListener('click', function() {
            const clienteSearch = document.getElementById('cliente-search');
            if (clienteSearch) {
                clienteSearch.value = '';
                clearClientInfo();
            }
        });
        console.log('✓ Botón limpiar cliente configurado');
    }
    
    // Configurar listeners de opciones de precio
    document.querySelectorAll('.price-option').forEach(option => {
        option.addEventListener('click', function() {
            document.querySelectorAll('.price-option').forEach(opt => opt.classList.remove('active'));
            this.classList.add('active');
        });
    });
    console.log('✓ Opciones de precio configuradas');
    
    // Configurar el primer botón de descuento como activo
    const firstDiscountBtn = document.querySelector('.discount-btn[data-discount="0"]');
    if (firstDiscountBtn) {
        firstDiscountBtn.classList.add('active');
        console.log('✓ Botón de descuento inicial configurado');
    }
    
    // Inicializar primer carrito
    updateCartDisplay();
    updateTotals();
    updateCloseButtonsVisibility();
    console.log('✓ Carrito inicial configurado');
    
    // Verificar productos en el grid
    const productCards = document.querySelectorAll('.product-card-enhanced');
    console.log(`✓ ${productCards.length} productos cargados en el grid`);
    
    // Verificar que todos los productos tengan los datos necesarios
    let productosConErrores = 0;
    productCards.forEach((card, idx) => {
        const id = card.getAttribute('data-product-id');
        const name = card.getAttribute('data-product-name');
        const price = card.getAttribute('data-product-price');
        const stock = card.getAttribute('data-product-stock');
        
        if (!id || !name || !price || !stock) {
            productosConErrores++;
            console.warn(`Producto ${idx + 1} con datos incompletos:`, { id, name, price, stock });
        }
    });
    
    if (productosConErrores > 0) {
        console.warn(`⚠ ${productosConErrores} productos tienen datos incompletos`);
    }
    
    // Guardar carritos en localStorage cuando se cierre la página
    window.addEventListener('beforeunload', function() {
        try {
            localStorage.setItem('pos_carts', JSON.stringify(carts));
            localStorage.setItem('pos_currentTabId', currentTabId);
            localStorage.setItem('pos_tabCounter', tabCounter);
            console.log('Estado guardado en localStorage');
        } catch (e) {
            console.error('Error guardando estado:', e);
        }
    });
    
    // Restaurar carritos desde localStorage si existen
    try {
        const savedCarts = localStorage.getItem('pos_carts');
        const savedTabId = localStorage.getItem('pos_currentTabId');
        const savedCounter = localStorage.getItem('pos_tabCounter');
        
        if (savedCarts) {
            const parsedCarts = JSON.parse(savedCarts);
            // Solo restaurar si tiene sentido (al menos un carrito)
            if (Object.keys(parsedCarts).length > 0) {
                // Usar showConfirm personalizado de forma async
                (async () => {
                    const shouldRestore = await showConfirm({
                        title: '¿Restaurar Sesión Anterior?',
                        message: '¿Desea restaurar las ventas pendientes de la sesión anterior?',
                        type: 'info',
                        confirmText: 'Sí, restaurar',
                        cancelTextLabel: 'No, nueva sesión'
                    });
                    
                    if (shouldRestore) {
                        carts = parsedCarts;
                        if (savedTabId) currentTabId = savedTabId;
                        if (savedCounter) tabCounter = parseInt(savedCounter);
                        
                        updateCartDisplay();
                        updateTotals();
                        updateClientDisplay();
                        
                        console.log('✓ Sesión anterior restaurada');
                        showToast('Sesión anterior restaurada correctamente', 'success');
                    } else {
                        localStorage.removeItem('pos_carts');
                        localStorage.removeItem('pos_currentTabId');
                        localStorage.removeItem('pos_tabCounter');
                        console.log('Estado anterior descartado');
                        showToast('Nueva sesión iniciada', 'info');
                    }
                })();
            }
        }
    } catch (e) {
        console.error('Error restaurando estado:', e);
    }
    
    console.log('===========================================');
    console.log('✓ POS Mejorado inicializado correctamente');
    console.log('===========================================');
    showToast('Sistema POS listo para usar', 'success');
});

// ============================================
// MODAL NUEVO CLIENTE
// ============================================

function abrirModalNuevoCliente() {
    const modal = new bootstrap.Modal(document.getElementById('modalNuevoCliente'));
    const modalBody = document.getElementById('modal-cliente-body');
    
    // Mostrar loading
    modalBody.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-2">Cargando formulario...</p>
        </div>
    `;
    
    modal.show();
    
    // Cargar formulario via AJAX
    fetch('/clientes/crear/')
        .then(response => response.text())
        .then(html => {
            // Extraer solo el contenido del formulario
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const form = doc.querySelector('form');
            
            if (form) {
                // Modificar la acción del formulario para que sea AJAX
                form.setAttribute('id', 'form-nuevo-cliente');
                form.setAttribute('onsubmit', 'return guardarClienteModal(event)');
                
                modalBody.innerHTML = form.outerHTML;
            } else {
                modalBody.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Error al cargar el formulario
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error cargando formulario:', error);
            modalBody.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error de conexión. Inténtalo de nuevo.
                </div>
            `;
        });
}

function guardarClienteModal(event) {
    event.preventDefault();
    
    const form = document.getElementById('form-nuevo-cliente');
    const formData = new FormData(form);
    const submitBtn = form.querySelector('button[type="submit"]');
    
    // Deshabilitar botón
    if (submitBtn) {
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Guardando...';
    }
    
    fetch('/clientes/crear/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Cliente creado exitosamente', 'success');
            
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalNuevoCliente'));
            modal.hide();
            
            // Seleccionar el nuevo cliente en el POS
            if (data.cliente) {
                seleccionarClienteCreado(data.cliente);
            }
            
            // Limpiar formulario
            form.reset();
        } else {
            showToast(data.message || 'Error al crear cliente', 'error');
            
            // Mostrar errores en el formulario si existen
            if (data.errors) {
                for (const [field, errors] of Object.entries(data.errors)) {
                    const input = form.querySelector(`[name="${field}"]`);
                    if (input) {
                        input.classList.add('is-invalid');
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'invalid-feedback';
                        errorDiv.textContent = errors.join(', ');
                        input.parentNode.appendChild(errorDiv);
                    }
                }
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error al guardar cliente', 'error');
    })
    .finally(() => {
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-save me-2"></i>Guardar';
        }
    });
    
    return false;
}

function seleccionarClienteCreado(cliente) {
    const currentCart = getCurrentCart();
    
    // Guardar datos del cliente en el carrito
    currentCart.cliente_id = cliente.id;
    currentCart.cliente_nombre = `${cliente.nombres} ${cliente.apellidos}`;
    currentCart.cliente_documento = cliente.cedula_ruc;
    
    // Actualizar UI
    updateClientDisplay();
    
    showToast(`Cliente ${currentCart.cliente_nombre} seleccionado`, 'success');
}

</script>
{% endblock %}