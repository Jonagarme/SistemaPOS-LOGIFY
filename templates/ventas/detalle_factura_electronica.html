{% extends 'base.html' %}
{% load static %}

{% block title %}{{ titulo }}{% endblock %}

{% block extra_css %}
<style>
    .factura-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem 0;
        margin-bottom: 2rem;
        border-radius: 0 0 20px 20px;
    }
    
    .factura-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        overflow: hidden;
        margin-bottom: 2rem;
    }
    
    .info-section {
        background: #f8f9fa;
        border-left: 4px solid #667eea;
        padding: 1rem;
        margin: 1rem 0;
        border-radius: 0 10px 10px 0;
    }
    
    .cliente-info {
        background: linear-gradient(135deg, #a8e6cf 0%, #88d8c0 100%);
        color: #2d5a27;
        border-radius: 10px;
        padding: 1.5rem;
        margin: 1rem 0;
    }
    
    .productos-table {
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }
    
    .productos-table th {
        background: #495057;
        color: white;
        border: none;
        font-weight: 600;
        text-align: center;
    }
    
    .productos-table td {
        border-color: #e9ecef;
        vertical-align: middle;
        text-align: center;
    }
    
    .status-autorizado {
        background: #d4edda;
        color: #155724;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: bold;
        display: inline-block;
    }
    
    .btn-action {
        border-radius: 25px;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        margin: 0.25rem;
    }
    
    .total-section {
        background: linear-gradient(135deg, #ffeaa7 0%, #fab1a0 100%);
        color: #2d3436;
        border-radius: 15px;
        padding: 1.5rem;
        margin: 1rem 0;
    }
</style>
{% endblock %}

{% block content %}
<!-- Header de Factura -->
<div class="factura-header">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="h2 mb-1">
                    <i class="bi bi-file-earmark-text me-3"></i>{{ titulo }}
                </h1>
                <div class="mt-3">
                    <h3 class="mb-0">Número: {{ numero }}</h3>
                    <p class="mb-0 opacity-75">Fecha: {{ fecha|date:"d/m/Y H:i:s" }}</p>
                </div>
            </div>
            <div class="col-md-4 text-end">
                <div class="status-autorizado">
                    <i class="bi bi-check-circle-fill me-2"></i>{{ estado }}
                </div>
                <div class="mt-3 text-white">
                    <small>Autorización: {{ autorizacion }}</small><br>
                    <small>Ambiente: {{ ambiente }}</small>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <!-- Información de la Empresa y Cliente -->
    <div class="row">
        <div class="col-md-6">
            <div class="factura-card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-building me-2"></i>Información de la Empresa</h5>
                </div>
                <div class="card-body">
                    <h6><strong>EMPRESA DEMO S.A.</strong></h6>
                    <p class="mb-1">RUC: 0123456789001</p>
                    <p class="mb-1">Dirección: Av. Principal 123</p>
                    <p class="mb-1">Ciudad: Quito, Ecuador</p>
                    <p class="mb-1">Teléfono: (02) 123-4567</p>
                    <p class="mb-0">Email: info@empresa.com</p>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="cliente-info">
                <h5 class="mb-3"><i class="bi bi-person-circle me-2"></i>INFORMACIÓN DEL CLIENTE</h5>
                {% if factura.cliente %}
                    <div class="row">
                        <div class="col-sm-4"><strong>Cédula:</strong></div>
                        <div class="col-sm-8">{{ factura.cliente.numero_documento|default:"N/A" }}</div>
                    </div>
                    <div class="row">
                        <div class="col-sm-4"><strong>Cliente:</strong></div>
                        <div class="col-sm-8">{{ factura.cliente.nombres }} {{ factura.cliente.apellidos }}</div>
                    </div>
                    {% if factura.cliente.razon_social %}
                    <div class="row">
                        <div class="col-sm-4"><strong>Razón Social:</strong></div>
                        <div class="col-sm-8">{{ factura.cliente.razon_social }}</div>
                    </div>
                    {% endif %}
                    <div class="row">
                        <div class="col-sm-4"><strong>Dirección:</strong></div>
                        <div class="col-sm-8">{{ factura.cliente.direccion|default:"N/A" }}</div>
                    </div>
                    <div class="row">
                        <div class="col-sm-4"><strong>Teléfono:</strong></div>
                        <div class="col-sm-8">{{ factura.cliente.telefono|default:"N/A" }}</div>
                    </div>
                {% else %}
                    <p><strong>CLIENTE GENERAL</strong></p>
                    <p>Consumidor Final</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Detalles de Productos -->
    <div class="factura-card">
        <div class="card-header bg-secondary text-white">
            <h5 class="mb-0"><i class="bi bi-basket me-2"></i>DETALLE DE PRODUCTOS</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table productos-table mb-0">
                    <thead>
                        <tr>
                            <th>Código</th>
                            <th>Producto</th>
                            <th>Cant</th>
                            <th>Precio</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for detalle in detalles %}
                        <tr>
                            <td><strong>{{ detalle.producto.codigo }}</strong></td>
                            <td class="text-start">{{ detalle.producto.nombre }}</td>
                            <td>{{ detalle.cantidad }}</td>
                            <td>$ {{ detalle.precio_unitario|floatformat:2 }}</td>
                            <td><strong>$ {{ detalle.total_linea|floatformat:2 }}</strong></td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center py-3">
                                <span class="text-muted">No hay productos en esta factura</span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Resumen de Totales -->
    <div class="row">
        <div class="col-md-8">
            <!-- Información adicional -->
            <div class="info-section">
                <h6><i class="bi bi-info-circle me-2"></i>Información Adicional</h6>
                <div class="row">
                    <div class="col-sm-6">
                        <strong>Vendedor:</strong> {{ factura.vendedor.first_name }} {{ factura.vendedor.last_name }}
                    </div>
                    <div class="col-sm-6">
                        <strong>Forma de Pago:</strong> {{ factura.get_tipo_pago_display }}
                    </div>
                </div>
                {% if factura.observaciones %}
                <div class="mt-2">
                    <strong>Observaciones:</strong> {{ factura.observaciones }}
                </div>
                {% endif %}
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="total-section">
                <h6 class="text-center mb-3"><strong>RESUMEN</strong></h6>
                <div class="d-flex justify-content-between">
                    <span>Subtotal:</span>
                    <span><strong>$ {{ factura.subtotal|floatformat:2 }}</strong></span>
                </div>
                {% if factura.descuento > 0 %}
                <div class="d-flex justify-content-between">
                    <span>Descuento:</span>
                    <span><strong>-$ {{ factura.descuento|floatformat:2 }}</strong></span>
                </div>
                {% endif %}
                <div class="d-flex justify-content-between">
                    <span>IVA (15%):</span>
                    <span><strong>$ {{ factura.impuesto|floatformat:2 }}</strong></span>
                </div>
                <hr>
                <div class="d-flex justify-content-between h5">
                    <span><strong>TOTAL:</strong></span>
                    <span><strong>$ {{ factura.total|floatformat:2 }}</strong></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Acciones -->
    <div class="text-center my-4">
        <a href="{% url 'ventas:facturas_electronicas' %}" class="btn btn-secondary btn-action">
            <i class="bi bi-arrow-left me-2"></i>Volver a Lista
        </a>
        
        {% if factura.estado != 'anulada' %}
        <a href="{% url 'ventas:anular_factura_electronica' factura.pk %}" class="btn btn-danger btn-action" 
           onclick="return confirm('¿Está seguro de anular esta factura?')">
            <i class="bi bi-x-circle me-2"></i>Anular Factura
        </a>
        {% endif %}
        
        <button class="btn btn-success btn-action" onclick="window.print()">
            <i class="bi bi-printer me-2"></i>Imprimir
        </button>
        
        <a href="{% url 'ventas:reenviar_sri' factura.pk %}" class="btn btn-info btn-action">
            <i class="bi bi-cloud-arrow-up me-2"></i>Reenviar al SRI
        </a>
        
        <button class="btn btn-warning btn-action" onclick="descargarPDF()">
            <i class="bi bi-file-pdf me-2"></i>Descargar PDF
        </button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function descargarPDF() {
        // Implementar descarga de PDF
        alert('Función de descarga PDF en desarrollo');
    }

    // Estilo para impresión
    window.addEventListener('beforeprint', function() {
        document.querySelector('.factura-header').style.background = '#667eea';
        document.querySelector('.factura-header').style.color = 'white';
    });

    window.addEventListener('afterprint', function() {
        // Restaurar estilos después de imprimir
    });
</script>

<style media="print">
    .btn, .nav, .navbar, .sidebar {
        display: none !important;
    }
    
    .factura-card {
        box-shadow: none !important;
        border: 1px solid #ddd !important;
    }
    
    .container {
        max-width: 100% !important;
        margin: 0 !important;
        padding: 0 !important;
    }
    
    .factura-header {
        background: #667eea !important;
        color: white !important;
        -webkit-print-color-adjust: exact !important;
    }
</style>
{% endblock %}