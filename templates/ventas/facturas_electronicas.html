{% extends 'base.html' %}
{% load static %}

{% block title %}{{ titulo }}{% endblock %}

{% block extra_css %}
<style>
    .header-facturacion {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem 0;
        margin-bottom: 1.5rem;
        border-radius: 0 0 15px 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .filtros-card {
        background: white;
        border-radius: 10px;
        border: 1px solid #e9ecef;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        margin-bottom: 1.5rem;
    }
    
    .tabla-facturas {
        background: white;
        border-radius: 10px;
        border: 1px solid #e9ecef;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .status-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: 15px;
        font-weight: 600;
    }
    
    .status-PAGADA {
        background-color: #d4edda;
        color: #155724;
    }
    
    .status-EMITIDA {
        background-color: #fff3cd;
        color: #856404;
    }
    
    .status-ANULADA {
        background-color: #f8d7da;
        color: #721c24;
    }
    
    .btn-sm-custom {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        margin: 0 2px;
    }
    
    .factura-row:hover {
        background-color: #f8f9fa;
    }
</style>
{% endblock %}
        color: #155724;
    }
    
    .status-pendiente {
        background-color: #fff3cd;
        color: #856404;
    }
    
    .status-anulada {
        background-color: #f8d7da;
        color: #721c24;
    }
    
    .filter-section {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .btn-action {
        border-radius: 20px;
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        margin: 0.25rem;
    }
    
    .table-facturas {
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 0 15px rgba(0,0,0,0.05);
    }
    
    .table-facturas th {
        background: #6c757d;
        color: white;
        border: none;
        font-weight: 600;
    }
    
    .table-facturas td {
        border-color: #e9ecef;
        vertical-align: middle;
    }
    
    .search-input {
        border-radius: 25px;
        border: 2px solid #e9ecef;
        padding: 0.75rem 1.25rem;
        transition: border-color 0.3s ease;
    }
    
    .search-input:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }
</style>
{% endblock %}

{% block content %}
<!-- Header Principal -->
<div class="header-facturacion">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="h2 mb-1">
                    <i class="bi bi-receipt me-3"></i>{{ titulo }}
                </h1>
                <p class="mb-0 opacity-75">{{ subtitulo }}</p>
            </div>
            <div class="col-md-4 text-end">
                <div class="d-inline-block bg-white text-dark px-3 py-2 rounded-pill">
                    <strong>Total de Documentos: {{ total_documentos }}</strong>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid">
    <!-- Estadísticas Rápidas -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card stats-card">
                <div class="card-body text-center">
                    <div class="h2 text-primary mb-0">{{ total_documentos }}</div>
                    <div class="text-muted">Total Documentos</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card">
                <div class="card-body text-center">
                    <div class="h2 text-success mb-0">$ {{ total_facturado|floatformat:2 }}</div>
                    <div class="text-muted">Total Facturado</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card">
                <div class="card-body text-center">
                    <div class="h2 text-info mb-0">{{ page_obj.paginator.count }}</div>
                    <div class="text-muted">Resultados</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stats-card">
                <div class="card-body text-center">
                    <div class="h2 text-warning mb-0">85%</div>
                    <div class="text-muted">Autorizadas</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtros de Búsqueda -->
    <div class="filter-section">
        <form method="get" class="row g-3">
            <div class="col-md-2">
                <label class="form-label small fw-bold">CAJ401:</label>
                <select name="cajero" class="form-select">
                    <option value="">TODOS</option>
                    {% for cajero in cajeros_disponibles %}
                    <option value="{{ cajero.vendedor__username }}" {% if filtros.cajero == cajero.vendedor__username %}selected{% endif %}>
                        {{ cajero.vendedor__first_name|default:cajero.vendedor__username }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-md-2">
                <label class="form-label small fw-bold">Tipo Documento:</label>
                <select name="tipo_documento" class="form-select">
                    <option value="">TODOS</option>
                    <option value="factura" {% if filtros.tipo_documento == 'factura' %}selected{% endif %}>FACTURA</option>
                    <option value="nota_credito" {% if filtros.tipo_documento == 'nota_credito' %}selected{% endif %}>NOTA CRÉDITO</option>
                </select>
            </div>
            
            <div class="col-md-2">
                <label class="form-label small fw-bold">Estado:</label>
                <select name="estado" class="form-select">
                    <option value="">TODOS</option>
                    {% for value, label in estados_disponibles %}
                    <option value="{{ value }}" {% if filtros.estado == value %}selected{% endif %}>{{ label|upper }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-md-2">
                <label class="form-label small fw-bold">Estado SRI:</label>
                <select name="estado_sri" class="form-select">
                    <option value="">TODOS</option>
                    <option value="autorizado">AUTORIZADO</option>
                    <option value="pendiente">PENDIENTE</option>
                    <option value="rechazado">RECHAZADO</option>
                </select>
            </div>
            
            <div class="col-md-2">
                <label class="form-label small fw-bold">Cajero:</label>
                <select name="cajero_filtro" class="form-select">
                    <option value="">TODOS</option>
                    {% for cajero in cajeros_disponibles %}
                    <option value="{{ cajero.vendedor__username }}">{{ cajero.vendedor__first_name|default:cajero.vendedor__username }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-primary me-2">
                    <i class="bi bi-search"></i> Buscar
                </button>
              <a href="{% url 'ventas:facturas_electronicas' %}" class="btn btn-secondary">
                <i class="bi bi-arrow-clockwise"></i> Limpiar
             </a>
            </div>
        </form>
        
        <!-- Segunda fila de filtros -->
        <form method="get" class="row g-3 mt-2">
            <div class="col-md-2">
                <label class="form-label small fw-bold">Número:</label>
                <input type="text" name="numero" class="form-control search-input" value="{{ filtros.numero }}" placeholder="Número de factura">
            </div>
            
            <div class="col-md-2">
                <label class="form-label small fw-bold">Cliente:</label>
                <input type="text" name="cliente" class="form-control search-input" value="{{ filtros.cliente }}" placeholder="Nombre del cliente">
            </div>
            
            <div class="col-md-2">
                <label class="form-label small fw-bold">Fecha Inicio:</label>
                <input type="date" name="fecha_inicio" class="form-control" value="{{ filtros.fecha_inicio }}">
            </div>
            
            <div class="col-md-2">
                <label class="form-label small fw-bold">Fecha Fin:</label>
                <input type="date" name="fecha_fin" class="form-control" value="{{ filtros.fecha_fin }}">
            </div>
            
            <div class="col-md-4 d-flex align-items-end">
                <button type="submit" class="btn btn-success me-2">
                    <i class="bi bi-funnel"></i> Filtrar
                </button>
            </div>
        </form>
    </div>

    <!-- Botones de Acción -->
    <div class="row mb-3">
        <div class="col-md-6">
            <h5>Lista de Facturas</h5>
        </div>
        <div class="col-md-6 text-end">
            <button class="btn btn-purple btn-action">
                <i class="bi bi-printer"></i> Imprimir
            </button>
            <button class="btn btn-warning btn-action">
                <i class="bi bi-download"></i> Exportar
            </button>
            <button class="btn btn-info btn-action">
                <i class="bi bi-cloud-arrow-up"></i> Actualizar
            </button>
        </div>
    </div>

    <!-- Tabla de Facturas -->
    <div class="table-responsive">
        <table class="table table-facturas table-hover">
            <thead>
                <tr>
                    <th>Documento</th>
                    <th>Fecha</th>
                    <th>Cliente</th>
                    <th>Total</th>
                    <th>Estado</th>
                    <th class="text-center">Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for factura in page_obj %}
                <tr class="factura-row" data-id="{{ factura.id }}">
                    <td>
                        <strong>{{ factura.numero_factura }}</strong>
                        <br>
                        <small class="text-muted">{{ factura.fecha|date:"H:i" }}</small>
                    </td>
                    <td>
                        {{ factura.fecha|date:"d/m/Y" }}
                        <br>
                        <small class="text-muted">{{ factura.fecha|date:"H:i:s" }}</small>
                    </td>
                    <td>
                        {% if factura.cliente %}
                            <strong>{{ factura.cliente.nombres }} {{ factura.cliente.apellidos }}</strong>
                            {% if factura.cliente.razon_social %}
                            <br><small class="text-muted">{{ factura.cliente.razon_social }}</small>
                            {% endif %}
                        {% else %}
                            <span class="text-muted">Cliente General</span>
                        {% endif %}
                    </td>
                    <td>
                        <strong class="text-success">$ {{ factura.total|floatformat:2 }}</strong>
                    </td>
                    <td>
                        {% if factura.estado == 'completada' %}
                            <span class="status-badge status-autorizado">AUTORIZADO</span>
                        {% elif factura.estado == 'pendiente' %}
                            <span class="status-badge status-pendiente">PENDIENTE</span>
                        {% elif factura.estado == 'anulada' %}
                            <span class="status-badge status-anulada">ANULADA</span>
                        {% else %}
                            <span class="status-badge status-pendiente">{{ factura.get_estado_display|upper }}</span>
                        {% endif %}
                    </td>
                    <td class="text-center">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-sm btn-outline-primary btn-ver-detalle" data-factura-id="{{ factura.id }}">
                                <i class="bi bi-eye"></i>
                            </button>
                            {% if factura.estado != 'anulada' %}
                            <button type="button" class="btn btn-sm btn-outline-danger btn-anular-factura" data-factura-id="{{ factura.id }}">
                                <i class="bi bi-x-circle"></i>
                            </button>
                            {% endif %}
                            <button type="button" class="btn btn-sm btn-outline-info btn-reenviar-sri" data-factura-id="{{ factura.id }}">
                                <i class="bi bi-cloud-arrow-up"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6" class="text-center py-4">
                        <div class="text-muted">
                            <i class="bi bi-inbox display-1"></i>
                            <p class="mt-3">No se encontraron facturas con los criterios especificados</p>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Paginación -->
    {% if page_obj.has_other_pages %}
    <nav aria-label="Paginación de facturas" class="mt-4">
        <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page=1{% for key, value in filtros.items %}{% if value %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                        <i class="bi bi-chevron-double-left"></i>
                    </a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% for key, value in filtros.items %}{% if value %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                        <i class="bi bi-chevron-left"></i>
                    </a>
                </li>
            {% endif %}

            <li class="page-item active">
                <span class="page-link">
                    Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
                </span>
            </li>

            {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.next_page_number }}{% for key, value in filtros.items %}{% if value %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                        <i class="bi bi-chevron-right"></i>
                    </a>
                </li>
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% for key, value in filtros.items %}{% if value %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                        <i class="bi bi-chevron-double-right"></i>
                    </a>
                </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>

<!-- Modal para detalles de factura -->
<div class="modal fade" id="detalleFacturaModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalle de Factura</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="detalleFacturaContent">
                <!-- Contenido del detalle se cargará aquí -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Event listeners para botones de acciones
        document.querySelectorAll('.btn-ver-detalle').forEach(btn => {
            btn.addEventListener('click', function() {
                const facturaId = this.getAttribute('data-factura-id');
                verDetalle(facturaId);
            });
        });

        document.querySelectorAll('.btn-anular-factura').forEach(btn => {
            btn.addEventListener('click', function() {
                const facturaId = this.getAttribute('data-factura-id');
                anularFactura(facturaId);
            });
        });

        document.querySelectorAll('.btn-reenviar-sri').forEach(btn => {
            btn.addEventListener('click', function() {
                const facturaId = this.getAttribute('data-factura-id');
                reenviarSRI(facturaId);
            });
        });

        // Resaltar fila seleccionada
        document.querySelectorAll('.factura-row').forEach(row => {
            row.addEventListener('click', function() {
                document.querySelectorAll('.factura-row').forEach(r => r.classList.remove('table-active'));
                this.classList.add('table-active');
            });
        });

        // Auto-submit en algunos filtros
        document.querySelectorAll('select[name="estado"], select[name="cajero"]').forEach(select => {
            select.addEventListener('change', function() {
                this.form.submit();
            });
        });
    });

    function verDetalle(facturaId) {
        // Cargar detalle de factura via AJAX
        window.location.href = `{% url 'ventas:detalle_factura_electronica' 0 %}`.replace('0', facturaId);
    }

    function anularFactura(facturaId) {
        if (confirm('¿Está seguro de que desea anular esta factura? Esta acción no se puede deshacer.')) {
            window.location.href = `{% url 'ventas:anular_factura_electronica' 0 %}`.replace('0', facturaId);
        }
    }

    function reenviarSRI(facturaId) {
        if (confirm('¿Desea reenviar esta factura al SRI?')) {
            window.location.href = `{% url 'ventas:reenviar_sri' 0 %}`.replace('0', facturaId);
        }
    }
</script>
{% endblock %}