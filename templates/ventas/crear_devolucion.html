{% extends 'base.html' %}
{% load static %}

{% block title %}{{ titulo }}{% endblock %}

{% block extra_css %}
<style>
.search-section {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
    border-radius: 10px;
    padding: 30px;
    margin-bottom: 30px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.search-box {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 8px;
    padding: 15px;
    color: white;
}

.search-box::placeholder {
    color: rgba(255, 255, 255, 0.7);
}

.btn-buscar {
    background: rgba(255, 255, 255, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: white;
    font-weight: bold;
}

.btn-buscar:hover {
    background: rgba(255, 255, 255, 0.3);
    color: white;
}

.venta-info {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
}

.producto-item {
    border: 1px solid #e9ecef;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 10px;
    transition: all 0.3s ease;
}

.producto-item:hover {
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.producto-seleccionado {
    border-color: #28a745;
    background-color: #f8fff8;
}

.cantidad-input {
    max-width: 100px;
}

.motivo-section {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 8px;
    padding: 20px;
    margin-top: 20px;
}

.btn-procesar {
    background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    border: none;
    color: white;
    font-weight: bold;
    padding: 12px 30px;
}

.btn-procesar:hover {
    background: linear-gradient(135deg, #c82333 0%, #dc3545 100%);
    color: white;
}

.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    display: none;
}

.spinner-border-lg {
    width: 3rem;
    height: 3rem;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="text-center text-white">
            <div class="spinner-border spinner-border-lg text-light" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <div class="mt-3">
                <h5>Procesando búsqueda...</h5>
            </div>
        </div>
    </div>

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-plus-circle text-success"></i> {{ titulo }}</h2>
            <p class="text-muted mb-0">{{ subtitulo }}</p>
        </div>
        <div>
            <a href="{% url 'ventas:devoluciones' %}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Volver a Lista
            </a>
        </div>
    </div>

    <!-- Sección de Búsqueda -->
    <div class="search-section">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h4 class="mb-3"><i class="fas fa-search"></i> Buscar Factura para Devolver</h4>
                <div class="input-group input-group-lg">
                    <input type="text" class="form-control search-box" id="numeroFactura" 
                           placeholder="Ingrese el número de factura (ej: FAC-20251028-0001)" 
                           autocomplete="off">
                    <button class="btn btn-buscar btn-lg" type="button" onclick="buscarVenta()">
                        <i class="fas fa-search"></i> Buscar Factura
                    </button>
                </div>
                <small class="text-white-50 mt-2 d-block">
                    <i class="fas fa-info-circle"></i> Solo se pueden devolver productos de facturas completadas
                </small>
            </div>
            <div class="col-md-4 text-center">
                <i class="fas fa-receipt fa-4x opacity-75"></i>
            </div>
        </div>
    </div>

    <!-- Información de la Venta (oculto inicialmente) -->
    <div id="ventaInfo" style="display: none;">
        <div class="venta-info">
            <div class="row">
                <div class="col-md-6">
                    <h5 class="text-primary mb-3"><i class="fas fa-receipt"></i> Información de la Factura</h5>
                    <table class="table table-sm">
                        <tr>
                            <td><strong>Número de Factura:</strong></td>
                            <td id="infoNumeroFactura">-</td>
                        </tr>
                        <tr>
                            <td><strong>Fecha de Venta:</strong></td>
                            <td id="infoFechaVenta">-</td>
                        </tr>
                        <tr>
                            <td><strong>Total Original:</strong></td>
                            <td id="infoTotalOriginal">-</td>
                        </tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <h5 class="text-info mb-3"><i class="fas fa-user"></i> Información del Cliente</h5>
                    <table class="table table-sm">
                        <tr>
                            <td><strong>Nombre:</strong></td>
                            <td id="infoClienteNombre">-</td>
                        </tr>
                        <tr>
                            <td><strong>Documento:</strong></td>
                            <td id="infoClienteDocumento">-</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>

        <!-- Formulario de Devolución -->
        <form id="formDevolucion" method="post" action="{% url 'ventas:crear_devolucion' %}">
            {% csrf_token %}
            <input type="hidden" id="ventaId" name="venta_id" value="">

            <!-- Productos Disponibles para Devolución -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-boxes"></i> Productos Disponibles para Devolución
                        <span class="badge bg-info ms-2" id="totalProductos">0</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div id="productosContainer">
                        <!-- Los productos se cargarán aquí dinámicamente -->
                    </div>
                </div>
            </div>

            <!-- Motivo y Observaciones -->
            <div class="motivo-section">
                <h5 class="mb-3"><i class="fas fa-clipboard-list"></i> Motivo de la Devolución</h5>
                <div class="row">
                    <div class="col-md-6">
                        <label for="motivo" class="form-label">Motivo *</label>
                        <select class="form-select" id="motivo" name="motivo" required>
                            <option value="">Seleccione un motivo</option>
                            {% for motivo_code, motivo_display in motivos_devolucion %}
                                <option value="{{ motivo_code }}">{{ motivo_display }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="observaciones" class="form-label">Observaciones</label>
                        <textarea class="form-control" id="observaciones" name="observaciones" rows="3" 
                                  placeholder="Detalles adicionales sobre la devolución (opcional)"></textarea>
                    </div>
                </div>
            </div>

            <!-- Resumen y Botones -->
            <div class="row mt-4">
                <div class="col-md-8">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Importante:</strong> Los productos devueltos serán restituidos al inventario automáticamente.
                        Esta acción no se puede deshacer una vez procesada.
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body text-center">
                            <h6>Total a Devolver</h6>
                            <h3 class="text-danger" id="totalDevolucion">$ 0.00</h3>
                            <button type="submit" class="btn btn-procesar btn-lg w-100 mt-3" id="btnProcesar" disabled>
                                <i class="fas fa-check"></i> Procesar Devolución
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- Mensajes de Error/Información -->
    <div id="mensajesContainer" style="display: none;">
        <div class="alert alert-dismissible fade show" id="alertMessage" role="alert">
            <span id="alertText"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let ventaSeleccionada = null;
let productosDisponibles = [];

// Buscar venta por número de factura
function buscarVenta() {
    const numeroFactura = document.getElementById('numeroFactura').value.trim();
    
    
    if (!numeroFactura) {
        mostrarMensaje('Por favor ingrese un número de factura', 'warning');
        return;
    }

    // Mostrar loading
    document.getElementById('loadingOverlay').style.display = 'flex';

    // Realizar petición AJAX
    fetch(`{% url 'ventas:buscar_venta_devolucion' %}?numero_factura=${encodeURIComponent(numeroFactura)}`, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(response => {
        return response.json();
    })
    .then(data => {
        document.getElementById('loadingOverlay').style.display = 'none';
        
        if (data.success) {
            ventaSeleccionada = data.venta;
            productosDisponibles = data.venta.detalles;
            mostrarVentaEncontrada();
        } else {
            mostrarMensaje(data.error, 'danger');
            ocultarVentaInfo();
        }
    })
    .catch(error => {
        document.getElementById('loadingOverlay').style.display = 'none';
        console.error('DEBUG: Error en fetch:', error);
        mostrarMensaje('Error al buscar la factura. Intente nuevamente.', 'danger');
        ocultarVentaInfo();
    });
}

// Mostrar información de la venta encontrada
function mostrarVentaEncontrada() {
    // Llenar información de la venta
    document.getElementById('infoNumeroFactura').textContent = ventaSeleccionada.numero_factura;
    document.getElementById('infoFechaVenta').textContent = ventaSeleccionada.fecha;
    document.getElementById('infoTotalOriginal').textContent = `$ ${ventaSeleccionada.total_original.toFixed(2)}`;
    
    // Llenar información del cliente
    document.getElementById('infoClienteNombre').textContent = ventaSeleccionada.cliente.nombre;
    document.getElementById('infoClienteDocumento').textContent = ventaSeleccionada.cliente.documento || 'No disponible';
    
    // Establecer ID de venta
    document.getElementById('ventaId').value = ventaSeleccionada.id;
    
    // Generar lista de productos
    generarListaProductos();
    
    // Mostrar sección de venta
    document.getElementById('ventaInfo').style.display = 'block';
    
    // Scroll hacia la información
    document.getElementById('ventaInfo').scrollIntoView({ behavior: 'smooth' });
    
    mostrarMensaje(`Factura encontrada: ${productosDisponibles.length} productos disponibles para devolución`, 'success');
}

// Generar lista de productos disponibles
function generarListaProductos() {
    const container = document.getElementById('productosContainer');
    const totalProductos = document.getElementById('totalProductos');
    
    totalProductos.textContent = productosDisponibles.length;
    
    let html = '';
    
    productosDisponibles.forEach((producto, index) => {
        html += `
            <div class="producto-item" id="producto_${producto.id}">
                <div class="row align-items-center">
                    <div class="col-md-1">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" 
                                   id="devolver_${producto.id}" name="devolver_${producto.id}"
                                   onchange="toggleProducto(${producto.id})">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div>
                            <strong>${producto.producto_nombre}</strong>
                            <br>
                            <small class="text-muted">Código: ${producto.producto_codigo}</small>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <small class="text-muted">Cantidad Original:</small>
                        <br>
                        <span class="badge bg-primary">${producto.cantidad_original}</span>
                    </div>
                    <div class="col-md-2">
                        <small class="text-muted">Disponible:</small>
                        <br>
                        <span class="badge bg-success">${producto.cantidad_disponible}</span>
                    </div>
                    <div class="col-md-1">
                        <label class="form-label">Devolver:</label>
                        <input type="number" class="form-control cantidad-input" 
                               id="cantidad_${producto.id}" name="cantidad_${producto.id}"
                               min="1" max="${producto.cantidad_disponible}" value="1"
                               disabled onchange="calcularTotal()">
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-md-12">
                        <div class="d-flex justify-content-between">
                            <small class="text-muted">
                                Precio unitario: $ ${producto.precio_unitario.toFixed(2)}
                            </small>
                            <small class="text-success">
                                <strong>Subtotal disponible: $ ${producto.subtotal_disponible.toFixed(2)}</strong>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// Toggle selección de producto
function toggleProducto(productoId) {
    const checkbox = document.getElementById(`devolver_${productoId}`);
    const cantidadInput = document.getElementById(`cantidad_${productoId}`);
    const productoDiv = document.getElementById(`producto_${productoId}`);
    
    if (checkbox.checked) {
        cantidadInput.disabled = false;
        productoDiv.classList.add('producto-seleccionado');
    } else {
        cantidadInput.disabled = true;
        cantidadInput.value = 1;
        productoDiv.classList.remove('producto-seleccionado');
    }
    
    calcularTotal();
}

// Calcular total de devolución
function calcularTotal() {
    let total = 0;
    let productosSeleccionados = 0;
    
    productosDisponibles.forEach(producto => {
        const checkbox = document.getElementById(`devolver_${producto.id}`);
        const cantidadInput = document.getElementById(`cantidad_${producto.id}`);
        
        if (checkbox.checked && !cantidadInput.disabled) {
            const cantidad = parseInt(cantidadInput.value) || 0;
            total += cantidad * producto.precio_unitario;
            productosSeleccionados++;
        }
    });
    
    document.getElementById('totalDevolucion').textContent = `$ ${total.toFixed(2)}`;
    
    // Habilitar/deshabilitar botón de procesar
    const btnProcesar = document.getElementById('btnProcesar');
    btnProcesar.disabled = productosSeleccionados === 0;
}

// Ocultar información de venta
function ocultarVentaInfo() {
    document.getElementById('ventaInfo').style.display = 'none';
    ventaSeleccionada = null;
    productosDisponibles = [];
}

// Mostrar mensaje
function mostrarMensaje(texto, tipo) {
    const container = document.getElementById('mensajesContainer');
    const alert = document.getElementById('alertMessage');
    const alertText = document.getElementById('alertText');
    
    // Limpiar clases anteriores
    alert.className = 'alert alert-dismissible fade show';
    alert.classList.add(`alert-${tipo}`);
    
    alertText.textContent = texto;
    container.style.display = 'block';
    
    // Auto-hide después de 5 segundos
    setTimeout(() => {
        container.style.display = 'none';
    }, 5000);
}

// Buscar al presionar Enter
document.getElementById('numeroFactura').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        buscarVenta();
    }
});

// Validación del formulario
document.getElementById('formDevolucion').addEventListener('submit', function(e) {
    const motivo = document.getElementById('motivo').value;
    
    if (!motivo) {
        e.preventDefault();
        mostrarMensaje('Debe seleccionar un motivo para la devolución', 'warning');
        return false;
    }
    
    // Verificar que al menos un producto esté seleccionado
    let productosSeleccionados = 0;
    productosDisponibles.forEach(producto => {
        const checkbox = document.getElementById(`devolver_${producto.id}`);
        if (checkbox.checked) {
            productosSeleccionados++;
        }
    });
    
    if (productosSeleccionados === 0) {
        e.preventDefault();
        mostrarMensaje('Debe seleccionar al menos un producto para devolver', 'warning');
        return false;
    }
    
    return true;
});
</script>
{% endblock %}