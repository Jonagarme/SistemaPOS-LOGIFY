{% extends 'base.html' %}
{% load static %}

{% block title %}Nueva Compra - Sistema POS{% endblock %}

{% block extra_css %}
<style>
.product-search-container {
    position: relative;
}

.product-suggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #ddd;
    border-top: none;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
    display: none;
}

.product-suggestion {
    padding: 10px;
    cursor: pointer;
    border-bottom: 1px solid #eee;
}

.product-suggestion:hover {
    background-color: #f8f9fa;
}

.product-suggestion:last-child {
    border-bottom: none;
}

.purchase-item {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 5px;
    padding: 15px;
    margin-bottom: 10px;
}

.purchase-summary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 10px;
    padding: 20px;
}

.btn-remove-item {
    background: #dc3545;
    border: none;
    color: white;
    width: 35px;
    height: 35px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.btn-remove-item:hover {
    background: #c82333;
    color: white;
}
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="row align-items-center">
                    <div class="col">
                        <h5 class="mb-0">
                            <i class="fas fa-plus-circle"></i> Nueva Compra
                        </h5>
                    </div>
                    <div class="col-auto">
                        <a href="{% url 'inventario:compras' %}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Volver a Compras
                        </a>
                    </div>
                </div>
            </div>
            
            <div class="card-body">
                <form method="post" id="form-nueva-compra">
                    {% csrf_token %}
                    
                    <!-- Información General -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-info-circle"></i> Información General</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="proveedor" class="form-label">Proveedor *</label>
                                        <select name="proveedor" id="proveedor" class="form-select" required>
                                            <option value="">Seleccionar proveedor...</option>
                                            {% for proveedor in proveedores %}
                                            <option value="{{ proveedor.id }}">{{ proveedor.nombre_comercial }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="numero_factura_proveedor" class="form-label">Número de Factura del Proveedor</label>
                                        <input type="text" name="numero_factura_proveedor" id="numero_factura_proveedor" class="form-control" placeholder="Ej: FAC-001">
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="fecha_factura" class="form-label">Fecha de Factura *</label>
                                        <input type="date" name="fecha_factura" id="fecha_factura" class="form-control" required>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="tipo_pago" class="form-label">Tipo de Pago</label>
                                        <select name="tipo_pago" id="tipo_pago" class="form-select">
                                            <option value="efectivo">Efectivo</option>
                                            <option value="credito">Crédito</option>
                                            <option value="transferencia">Transferencia</option>
                                            <option value="cheque">Cheque</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-search"></i> Agregar Productos</h6>
                                </div>
                                <div class="card-body">
                                    <div class="product-search-container">
                                        <label for="search-product" class="form-label">Buscar Producto</label>
                                        <input type="text" id="search-product" class="form-control" placeholder="Buscar por nombre o código...">
                                        <div id="product-suggestions" class="product-suggestions"></div>
                                    </div>
                                    
                                    <div class="mt-3">
                                        <small class="text-muted">
                                            <i class="fas fa-info-circle"></i> Escribe el nombre o código del producto para buscarlo
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Lista de Productos -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0"><i class="fas fa-list"></i> Productos de la Compra</h6>
                        </div>
                        <div class="card-body">
                            <div id="purchase-items">
                                <div class="text-center text-muted py-4">
                                    <i class="fas fa-shopping-cart fa-3x mb-3"></i>
                                    <p>No hay productos agregados a la compra</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Resumen y Totales -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0"><i class="fas fa-comment"></i> Observaciones</h6>
                                </div>
                                <div class="card-body">
                                    <textarea name="observaciones" id="observaciones" class="form-control" rows="4" placeholder="Observaciones adicionales..."></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="purchase-summary">
                                <h6 class="mb-3"><i class="fas fa-calculator"></i> Resumen de Compra</h6>
                                
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Subtotal:</span>
                                    <span id="subtotal">$0.00</span>
                                </div>
                                
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Descuento:</span>
                                    <div class="d-flex">
                                        <input type="number" name="descuento" id="descuento" class="form-control form-control-sm me-2" value="0" min="0" step="0.01" style="width: 80px;">
                                        <span class="align-self-center">$</span>
                                    </div>
                                </div>
                                
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Impuesto (IVA):</span>
                                    <span id="impuesto">$0.00</span>
                                </div>
                                
                                <hr>
                                
                                <div class="d-flex justify-content-between">
                                    <strong>Total:</strong>
                                    <strong id="total">$0.00</strong>
                                </div>
                                
                                <div class="mt-4">
                                    <button type="submit" class="btn btn-light btn-lg w-100">
                                        <i class="fas fa-save"></i> Guardar Compra
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Variables globales
let purchaseItems = [];
let searchTimeout = null;

// Configurar fecha actual por defecto
document.addEventListener('DOMContentLoaded', function() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('fecha_factura').value = today;
});

// Búsqueda de productos
document.getElementById('search-product').addEventListener('input', function() {
    const query = this.value.trim();
    
    clearTimeout(searchTimeout);
    
    if (query.length < 2) {
        hideProductSuggestions();
        return;
    }
    
    searchTimeout = setTimeout(() => {
        searchProducts(query);
    }, 300);
});

// Función para buscar productos
function searchProducts(query) {
    fetch(`/productos/api/buscar/?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showProductSuggestions(data.productos);
            }
        })
        .catch(error => {
            console.error('Error al buscar productos:', error);
        });
}

// Mostrar sugerencias de productos
function showProductSuggestions(productos) {
    const container = document.getElementById('product-suggestions');
    
    if (productos.length === 0) {
        container.innerHTML = '<div class="product-suggestion">No se encontraron productos</div>';
    } else {
        container.innerHTML = productos.map(producto => `
            <div class="product-suggestion" onclick="selectProduct(${producto.id}, '${producto.nombre}', ${producto.pvp_unidad || 0})">
                <strong>${producto.codigo_principal || 'S/C'}</strong> - ${producto.nombre}
                <br><small class="text-muted">Precio: $${(producto.pvp_unidad || 0).toFixed(2)} | Stock: ${producto.stock}</small>
            </div>
        `).join('');
    }
    
    container.style.display = 'block';
}

// Ocultar sugerencias
function hideProductSuggestions() {
    document.getElementById('product-suggestions').style.display = 'none';
}

// Seleccionar producto
function selectProduct(id, name, price) {
    // Verificar si el producto ya está en la lista
    const existingItem = purchaseItems.find(item => item.id === id);
    
    if (existingItem) {
        alert('Este producto ya está agregado a la compra');
        return;
    }
    
    // Agregar producto
    const item = {
        id: id,
        name: name,
        price: parseFloat(price) || 0,
        quantity: 1,
        subtotal: parseFloat(price) || 0
    };
    
    purchaseItems.push(item);
    
    // Limpiar búsqueda
    document.getElementById('search-product').value = '';
    hideProductSuggestions();
    
    // Actualizar vista
    updatePurchaseItemsView();
    updateTotals();
}

// Actualizar vista de productos
function updatePurchaseItemsView() {
    const container = document.getElementById('purchase-items');
    
    if (purchaseItems.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-shopping-cart fa-3x mb-3"></i>
                <p>No hay productos agregados a la compra</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = purchaseItems.map((item, index) => `
        <div class="purchase-item">
            <div class="row align-items-center">
                <div class="col-md-4">
                    <strong>${item.name}</strong>
                    <input type="hidden" name="productos[${index}][id]" value="${item.id}">
                </div>
                <div class="col-md-2">
                    <label class="form-label small">Cantidad</label>
                    <input type="number" class="form-control form-control-sm" value="${item.quantity}" min="1" 
                           onchange="updateItemQuantity(${index}, this.value)"
                           name="productos[${index}][cantidad]">
                </div>
                <div class="col-md-2">
                    <label class="form-label small">Precio Unit.</label>
                    <input type="number" class="form-control form-control-sm" value="${item.price}" min="0" step="0.01"
                           onchange="updateItemPrice(${index}, this.value)"
                           name="productos[${index}][precio]">
                </div>
                <div class="col-md-2">
                    <label class="form-label small">Subtotal</label>
                    <input type="text" class="form-control form-control-sm" value="$${item.subtotal.toFixed(2)}" readonly>
                </div>
                <div class="col-md-2 text-end">
                    <button type="button" class="btn-remove-item" onclick="removeItem(${index})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `).join('');
}

// Actualizar cantidad de item
function updateItemQuantity(index, quantity) {
    quantity = parseInt(quantity) || 1;
    purchaseItems[index].quantity = quantity;
    purchaseItems[index].subtotal = quantity * purchaseItems[index].price;
    
    updatePurchaseItemsView();
    updateTotals();
}

// Actualizar precio de item
function updateItemPrice(index, price) {
    price = parseFloat(price) || 0;
    purchaseItems[index].price = price;
    purchaseItems[index].subtotal = purchaseItems[index].quantity * price;
    
    updatePurchaseItemsView();
    updateTotals();
}

// Remover item
function removeItem(index) {
    purchaseItems.splice(index, 1);
    updatePurchaseItemsView();
    updateTotals();
}

// Actualizar totales
function updateTotals() {
    const subtotal = purchaseItems.reduce((sum, item) => sum + item.subtotal, 0);
    const descuento = parseFloat(document.getElementById('descuento').value) || 0;
    const impuesto = (subtotal - descuento) * 0.15; // IVA 15%
    const total = subtotal - descuento + impuesto;
    
    document.getElementById('subtotal').textContent = `$${subtotal.toFixed(2)}`;
    document.getElementById('impuesto').textContent = `$${impuesto.toFixed(2)}`;
    document.getElementById('total').textContent = `$${total.toFixed(2)}`;
}

// Event listener para descuento
document.getElementById('descuento').addEventListener('input', updateTotals);

// Cerrar sugerencias al hacer click fuera
document.addEventListener('click', function(e) {
    if (!e.target.closest('.product-search-container')) {
        hideProductSuggestions();
    }
});

// Validación antes de enviar
document.getElementById('form-nueva-compra').addEventListener('submit', function(e) {
    if (purchaseItems.length === 0) {
        e.preventDefault();
        alert('Debe agregar al menos un producto a la compra');
        return;
    }
    
    const proveedor = document.getElementById('proveedor').value;
    if (!proveedor) {
        e.preventDefault();
        alert('Debe seleccionar un proveedor');
        return;
    }
});
</script>
{% endblock %}