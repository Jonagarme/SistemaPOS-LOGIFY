{% extends 'base.html' %}

{% block title %}Dashboard de Productos Caducados - Sistema POS{% endblock %}

{% block extra_css %}
<style>
    .dashboard-card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        border: none;
        border-radius: 12px;
    }
    
    .dashboard-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    
    .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 12px;
    }
    
    .stat-card.danger {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
    }
    
    .stat-card.warning {
        background: linear-gradient(135deg, #feca57 0%, #ff9ff3 100%);
    }
    
    .stat-card.success {
        background: linear-gradient(135deg, #48cab2 0%, #2dd4bf 100%);
    }
    
    .chart-container {
        position: relative;
        height: 300px;
        background: #fff;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .productos-criticos {
        max-height: 400px;
        overflow-y: auto;
    }
    
    .producto-critico {
        border-left: 4px solid #dc3545;
        background: #f8f9fa;
        border-radius: 0 8px 8px 0;
        margin-bottom: 10px;
        padding: 10px;
        transition: background 0.3s ease;
    }
    
    .producto-critico:hover {
        background: #e9ecef;
    }
    
    .producto-critico.vencido {
        border-left-color: #dc3545;
        background: #fff5f5;
    }
    
    .producto-critico.por-vencer {
        border-left-color: #ffc107;
        background: #fffbf0;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2><i class="fas fa-chart-pie text-primary"></i> Dashboard de Productos Caducados</h2>
                    <p class="text-muted mb-0">Vista general del estado de vencimientos</p>
                </div>
                <div>
                    <a href="{% url 'inventario:reporte_productos_caducados' %}" class="btn btn-primary">
                        <i class="fas fa-list"></i> Ver Reporte Completo
                    </a>
                    <button class="btn btn-outline-secondary" onclick="actualizarDatos()">
                        <i class="fas fa-sync"></i> Actualizar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Estadísticas Principales -->
    <div class="row mb-4" id="estadisticas-cards">
        <!-- Se llenarán dinámicamente -->
    </div>

    <!-- Gráficos y Tablas -->
    <div class="row">
        <!-- Gráfico de Estado de Productos -->
        <div class="col-md-6 mb-4">
            <div class="card dashboard-card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-doughnut"></i> Estado de Productos</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="graficoEstados"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gráfico de Valor en Riesgo -->
        <div class="col-md-6 mb-4">
            <div class="card dashboard-card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-chart-bar"></i> Valor en Riesgo</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="graficoValores"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Productos Críticos -->
    <div class="row">
        <div class="col-12">
            <div class="card dashboard-card">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-exclamation-triangle"></i> 
                        Productos Críticos
                        <span class="badge bg-light text-dark ms-2" id="badge-criticos">0</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div id="productos-criticos" class="productos-criticos">
                        <!-- Se llenará dinámicamente -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading -->
    <div id="loading" class="text-center py-5" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
        <p class="mt-3 text-muted">Cargando datos del dashboard...</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let graficoEstados = null;
let graficoValores = null;

async function cargarDatos() {
    const loading = document.getElementById('loading');
    loading.style.display = 'block';
    
    try {
        const response = await fetch('{% url "inventario:dashboard_caducados" %}');
        const data = await response.json();
        
        actualizarEstadisticas(data);
        crearGraficoEstados(data.grafico_estados);
        crearGraficoValores(data.grafico_estados);
        mostrarProductosCriticos(data.productos_criticos);
        
    } catch (error) {
        console.error('Error al cargar datos:', error);
        mostrarError('Error al cargar los datos del dashboard');
    } finally {
        loading.style.display = 'none';
    }
}

function actualizarEstadisticas(data) {
    const container = document.getElementById('estadisticas-cards');
    
    // Calcular totales
    let totalProductos = 0;
    let totalVencidos = 0;
    let totalPorVencer = 0;
    let valorTotal = 0;
    
    data.grafico_estados.forEach(item => {
        totalProductos += item.cantidad;
        valorTotal += item.valor_total;
        
        if (item.estado === 'Vencidos') {
            totalVencidos = item.cantidad;
        } else if (item.estado === 'Por Vencer') {
            totalPorVencer = item.cantidad;
        }
    });
    
    container.innerHTML = `
        <div class="col-md-3 mb-3">
            <div class="card stat-card danger">
                <div class="card-body text-center">
                    <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                    <h3 class="fw-bold">${totalVencidos}</h3>
                    <p class="mb-0">Productos Vencidos</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card stat-card warning">
                <div class="card-body text-center">
                    <i class="fas fa-clock fa-2x mb-2"></i>
                    <h3 class="fw-bold">${totalPorVencer}</h3>
                    <p class="mb-0">Por Vencer</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card stat-card">
                <div class="card-body text-center">
                    <i class="fas fa-boxes fa-2x mb-2"></i>
                    <h3 class="fw-bold">${totalProductos}</h3>
                    <p class="mb-0">Total Productos</p>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card stat-card success">
                <div class="card-body text-center">
                    <i class="fas fa-dollar-sign fa-2x mb-2"></i>
                    <h3 class="fw-bold">$${valorTotal.toLocaleString()}</h3>
                    <p class="mb-0">Valor Total</p>
                </div>
            </div>
        </div>
    `;
}

function crearGraficoEstados(datos) {
    const ctx = document.getElementById('graficoEstados').getContext('2d');
    
    if (graficoEstados) {
        graficoEstados.destroy();
    }
    
    const labels = datos.map(item => item.estado);
    const valores = datos.map(item => item.cantidad);
    const colores = [
        '#dc3545', // Vencidos - Rojo
        '#ffc107', // Por Vencer - Amarillo
        '#28a745', // Vigentes - Verde
        '#6c757d'  // Sin Fecha - Gris
    ];
    
    graficoEstados = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: valores,
                backgroundColor: colores,
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                },
                title: {
                    display: true,
                    text: 'Distribución por Estado'
                }
            }
        }
    });
}

function crearGraficoValores(datos) {
    const ctx = document.getElementById('graficoValores').getContext('2d');
    
    if (graficoValores) {
        graficoValores.destroy();
    }
    
    const labels = datos.map(item => item.estado);
    const valores = datos.map(item => item.valor_total);
    const colores = [
        '#dc3545', // Vencidos - Rojo
        '#ffc107', // Por Vencer - Amarillo
        '#28a745', // Vigentes - Verde
        '#6c757d'  // Sin Fecha - Gris
    ];
    
    graficoValores = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Valor ($)',
                data: valores,
                backgroundColor: colores.map(color => color + '80'), // Transparencia
                borderColor: colores,
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toLocaleString();
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                title: {
                    display: true,
                    text: 'Valor por Estado'
                }
            }
        }
    });
}

function mostrarProductosCriticos(productos) {
    const container = document.getElementById('productos-criticos');
    const badge = document.getElementById('badge-criticos');
    
    badge.textContent = productos.length;
    
    if (productos.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-check-circle text-success fa-3x"></i>
                <h5 class="mt-3">¡Excelente!</h5>
                <p class="text-muted">No hay productos críticos en este momento</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    productos.forEach(producto => {
        const clase = producto.dias_restantes < 0 ? 'vencido' : 'por-vencer';
        const icono = producto.dias_restantes < 0 ? 'fas fa-times-circle text-danger' : 'fas fa-exclamation-circle text-warning';
        const estado = producto.dias_restantes < 0 ? 
            `Vencido hace ${Math.abs(producto.dias_restantes)} días` : 
            `Vence en ${producto.dias_restantes} días`;
        
        html += `
            <div class="producto-critico ${clase}">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1">
                            <i class="${icono}"></i>
                            ${producto.codigo} - ${producto.nombre}
                        </h6>
                        <small class="text-muted">Stock: ${producto.stock}</small>
                    </div>
                    <div class="text-end">
                        <span class="badge ${producto.dias_restantes < 0 ? 'bg-danger' : 'bg-warning text-dark'}">
                            ${estado}
                        </span>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function mostrarError(mensaje) {
    const container = document.getElementById('productos-criticos');
    container.innerHTML = `
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle"></i>
            ${mensaje}
        </div>
    `;
}

function actualizarDatos() {
    cargarDatos();
}

// Cargar datos al iniciar
document.addEventListener('DOMContentLoaded', function() {
    cargarDatos();
    
    // Auto-actualizar cada 5 minutos
    setInterval(cargarDatos, 300000);
});
</script>
{% endblock %}