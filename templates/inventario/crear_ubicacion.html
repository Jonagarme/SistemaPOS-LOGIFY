{% extends 'base.html' %}
{% load static %}

{% block title %}Nueva Ubicación{% endblock %}

{% block extra_css %}
<style>
    .card-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
    }
    .btn-primary:hover {
        background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        transform: translateY(-1px);
    }
    .form-icon {
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #6c757d;
    }
    .form-control-icon {
        padding-left: 45px;
    }
    .preview-card {
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        background: #f8f9fa;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-map-marker-alt"></i> Nueva Ubicación</h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'usuarios:dashboard' %}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="#">Inventario</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'inventario:ubicaciones' %}">Ubicaciones</a></li>
                    <li class="breadcrumb-item active">Nueva Ubicación</li>
                </ol>
            </nav>
        </div>
        <a href="{% url 'inventario:ubicaciones' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Volver a Ubicaciones
        </a>
    </div>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}

    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-plus"></i> Información de la Ubicación</h5>
                </div>
                <div class="card-body">
                    <form method="POST" id="form-ubicacion">
                        {% csrf_token %}
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Nombre de la Ubicación *</label>
                                <div class="position-relative">
                                    <i class="fas fa-building form-icon"></i>
                                    <input type="text" class="form-control form-control-icon" 
                                           name="nombre" id="nombre" required maxlength="100"
                                           placeholder="Ej: Sucursal Centro, Bodega Principal">
                                </div>
                                <div class="form-text">Nombre descriptivo de la ubicación</div>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Código de Ubicación *</label>
                                <div class="position-relative">
                                    <i class="fas fa-barcode form-icon"></i>
                                    <input type="text" class="form-control form-control-icon" 
                                           name="codigo" id="codigo" required maxlength="20"
                                           placeholder="Ej: SUC001, BOD001" style="text-transform: uppercase;">
                                </div>
                                <div class="form-text">Código único de identificación</div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Tipo de Ubicación *</label>
                                <div class="position-relative">
                                    <i class="fas fa-tags form-icon"></i>
                                    <select class="form-select form-control-icon" name="tipo" id="tipo" required>
                                        <option value="">Seleccione un tipo...</option>
                                        <option value="sucursal">Sucursal</option>
                                        <option value="bodega">Bodega</option>
                                        <option value="almacen">Almacén</option>
                                        <option value="deposito">Depósito</option>
                                        <option value="comercio">Establecimiento Comercial</option>
                                        <option value="clinica">Clínica</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Estado</label>
                                <div class="position-relative">
                                    <i class="fas fa-toggle-on form-icon"></i>
                                    <select class="form-select form-control-icon" name="activo" id="activo">
                                        <option value="True" selected>Activo</option>
                                        <option value="False">Inactivo</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Dirección</label>
                            <div class="position-relative">
                                <i class="fas fa-map-marker-alt form-icon"></i>
                                <input type="text" class="form-control form-control-icon" 
                                       name="direccion" id="direccion" maxlength="200"
                                       placeholder="Dirección completa de la ubicación">
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Teléfono</label>
                                <div class="position-relative">
                                    <i class="fas fa-phone form-icon"></i>
                                    <input type="tel" class="form-control form-control-icon" 
                                           name="telefono" id="telefono" maxlength="20"
                                           placeholder="Ej: +504 2234-5678">
                                </div>
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Email</label>
                                <div class="position-relative">
                                    <i class="fas fa-envelope form-icon"></i>
                                    <input type="email" class="form-control form-control-icon" 
                                           name="email" id="email" maxlength="100"
                                           placeholder="email@ejemplo.com">
                                </div>
                            </div>
                            
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Capacidad (m²)</label>
                                <div class="position-relative">
                                    <i class="fas fa-expand-arrows-alt form-icon"></i>
                                    <input type="number" class="form-control form-control-icon" 
                                           name="capacidad_m2" id="capacidad_m2" min="0" step="0.01"
                                           placeholder="Ej: 150.50">
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Descripción</label>
                            <textarea class="form-control" name="descripcion" id="descripcion" 
                                      rows="3" maxlength="500"
                                      placeholder="Descripción adicional de la ubicación, características especiales, etc."></textarea>
                            <div class="form-text">Máximo 500 caracteres</div>
                        </div>

                        <div class="text-end">
                            <a href="{% url 'inventario:ubicaciones' %}" class="btn btn-secondary me-2">
                                <i class="fas fa-times"></i> Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Guardar Ubicación
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <!-- Vista previa de la ubicación -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-eye"></i> Vista Previa</h5>
                </div>
                <div class="card-body">
                    <div class="preview-card" id="preview">
                        <i class="fas fa-map-marker-alt fa-3x text-muted mb-3"></i>
                        <h6 class="text-muted">Vista previa de la ubicación</h6>
                        <p class="text-muted small">Complete el formulario para ver una vista previa</p>
                    </div>
                </div>
            </div>

            <!-- Información de ayuda -->
            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-info-circle"></i> Información</h5>
                </div>
                <div class="card-body">
                    <h6><i class="fas fa-lightbulb text-warning"></i> Consejos:</h6>
                    <ul class="small text-muted">
                        <li>Use códigos únicos para cada ubicación</li>
                        <li>Mantenga nombres descriptivos y cortos</li>
                        <li>Complete la dirección para mejor control</li>
                        <li>La capacidad ayuda en la planificación</li>
                    </ul>
                    
                    <h6 class="mt-3"><i class="fas fa-info text-info"></i> Tipos de Ubicación:</h6>
                    <ul class="small text-muted">
                        <li><strong>Sucursal:</strong> Punto de venta</li>
                        <li><strong>Bodega:</strong> Almacenamiento principal</li>
                        <li><strong>Almacén:</strong> Depósito secundario</li>
                        <li><strong>Establecimiento:</strong> Punto de venta principal</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-uppercase para código
    document.getElementById('codigo').addEventListener('input', function() {
        this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
    });

    // Generar código automático basado en el nombre
    document.getElementById('nombre').addEventListener('input', function() {
        const nombre = this.value;
        const tipo = document.getElementById('tipo').value;
        
        if (nombre.length >= 3 && tipo) {
            const prefijo = tipo.substring(0, 3).toUpperCase();
            const nombreParts = nombre.split(' ');
            const nombreCode = nombreParts.map(part => part.substring(0, 2)).join('').toUpperCase();
            const codigo = prefijo + nombreCode.substring(0, 4);
            
            if (!document.getElementById('codigo').value) {
                document.getElementById('codigo').value = codigo;
            }
        }
        
        actualizarPreview();
    });

    // Actualizar preview cuando cambien los campos
    const campos = ['nombre', 'codigo', 'tipo', 'direccion', 'telefono'];
    campos.forEach(campo => {
        document.getElementById(campo).addEventListener('input', actualizarPreview);
    });

    function actualizarPreview() {
        const nombre = document.getElementById('nombre').value || 'Nombre de ubicación';
        const codigo = document.getElementById('codigo').value || 'CÓDIGO';
        const tipo = document.getElementById('tipo').value || 'tipo';
        const direccion = document.getElementById('direccion').value;
        const telefono = document.getElementById('telefono').value;

        const tipoDisplay = document.querySelector(`#tipo option[value="${tipo}"]`)?.textContent || 'Tipo';

        let preview = `
            <div class="text-start">
                <h5 class="text-primary mb-1"><i class="fas fa-building"></i> ${nombre}</h5>
                <p class="mb-1"><span class="badge bg-secondary">${codigo}</span> 
                   <span class="badge bg-info">${tipoDisplay}</span></p>
        `;

        if (direccion) {
            preview += `<p class="mb-1 small"><i class="fas fa-map-marker-alt text-muted"></i> ${direccion}</p>`;
        }

        if (telefono) {
            preview += `<p class="mb-1 small"><i class="fas fa-phone text-muted"></i> ${telefono}</p>`;
        }

        preview += '</div>';

        document.getElementById('preview').innerHTML = preview;
    }

    // Validación del formulario
    document.getElementById('form-ubicacion').addEventListener('submit', function(e) {
        const nombre = document.getElementById('nombre').value.trim();
        const codigo = document.getElementById('codigo').value.trim();
        const tipo = document.getElementById('tipo').value;

        if (!nombre || !codigo || !tipo) {
            e.preventDefault();
            alert('Por favor, complete todos los campos obligatorios (marcados con *)');
            return;
        }

        if (codigo.length < 3) {
            e.preventDefault();
            alert('El código debe tener al menos 3 caracteres');
            return;
        }
    });

    // Contador de caracteres para descripción
    const descripcion = document.getElementById('descripcion');
    const maxLength = 500;
    
    descripcion.addEventListener('input', function() {
        const length = this.value.length;
        const remaining = maxLength - length;
        
        let colorClass = 'text-muted';
        if (remaining < 50) colorClass = 'text-warning';
        if (remaining < 10) colorClass = 'text-danger';
        
        const helpText = this.parentNode.querySelector('.form-text');
        helpText.innerHTML = `${remaining} caracteres restantes`;
        helpText.className = `form-text ${colorClass}`;
    });
});
</script>
{% endblock %}